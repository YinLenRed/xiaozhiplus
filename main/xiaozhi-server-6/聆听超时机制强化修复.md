# è†å¬è¶…æ—¶æœºåˆ¶å¼ºåŒ–ä¿®å¤ - æœ€ç»ˆå®Œæˆ

## ğŸ“‹ é—®é¢˜æè¿°

**æ ¸å¿ƒé—®é¢˜**: ç¡¬ä»¶åœ¨è†å¬çŠ¶æ€ä¸‹ä¸ä¼šè‡ªåŠ¨é€€å‡ºï¼Œå³ä½¿Pythonå‘é€äº†åœæ­¢ä¿¡å·

**è¡¨ç°ç—‡çŠ¶**:
- ç”¨æˆ·è¯´å®Œè¯åï¼Œç¡¬ä»¶ç»§ç»­ä¿æŒè†å¬çŠ¶æ€
- Pythonæ—¥å¿—æ˜¾ç¤ºè¶…æ—¶è§¦å‘ï¼Œä½†ç¡¬ä»¶ä¸å“åº”
- æœ€ç»ˆå‡ºç°WebSocketå±æ€§é”™è¯¯å¯¼è‡´è¶…æ—¶å¤„ç†å¤±è´¥

## ğŸ” æ ¹å› åˆ†æ

### 1. åŸå§‹é—®é¢˜
- è†å¬è¶…æ—¶è§¦å‘åï¼Œç¡¬ä»¶ä¸å“åº”å•ä¸€ç±»å‹çš„åœæ­¢ä¿¡å·
- ä¸åŒç¡¬ä»¶ç‰ˆæœ¬å¯èƒ½å¯¹ä¸åŒæ ¼å¼çš„åœæ­¢ä¿¡å·æœ‰ä¸åŒå“åº”

### 2. WebSocketå±æ€§é”™è¯¯
```python
# é”™è¯¯ä»£ç 
websocket_connected = conn.websocket.open  # 'ServerConnection' object has no attribute 'open'
```

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### é˜¶æ®µä¸€: å¤šé‡åœæ­¢ä¿¡å·ç­–ç•¥

**å®ç°ä½ç½®**: `core/handle/textHandle.py::_send_listening_timeout_stop_signal()`

```python
async def _send_listening_timeout_stop_signal(conn):
    """å‘é€å¤šç§æ ¼å¼çš„è†å¬è¶…æ—¶åœæ­¢ä¿¡å·ï¼Œæé«˜ç¡¬ä»¶å“åº”æˆåŠŸç‡"""
    
    signals = [
        # æ ‡å‡†åœæ­¢ä¿¡å·
        {"type": "listening", "state": "stop", "reason": "timeout"},
        # å¼ºåˆ¶åœæ­¢ä¿¡å·  
        {"type": "listening", "state": "stop", "reason": "force", "force": True},
        # ç®€åŒ–æ ¼å¼
        {"type": "listening", "state": "stop"},
        # å…œåº•ä¿æŠ¤ - abortä¿¡å·
        {"type": "abort", "reason": "listening_timeout"}
    ]
    
    # é€ä¸ªå‘é€ï¼Œæ¯ä¸ªé—´éš”50ms
    for i, signal in enumerate(signals, 1):
        await conn.websocket.send(json.dumps(signal))
        conn.logger.info(f"ğŸ“¤ å‘é€è†å¬è¶…æ—¶åœæ­¢ä¿¡å· #{i}: {signal.get('reason', 'simple')}")
        if i < len(signals):
            await asyncio.sleep(0.05)
```

### é˜¶æ®µäºŒ: WebSocketçŠ¶æ€æ£€æŸ¥ä¿®å¤

**é—®é¢˜**: ä¸åŒWebSocketå®ç°çš„å±æ€§åä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**: å…¼å®¹å¤šç§WebSocketå®ç°
```python
# ä¿®å¤åçš„å®‰å…¨æ£€æŸ¥
websocket_status = "None"
if hasattr(conn, 'websocket') and conn.websocket:
    try:
        # å°è¯•ä¸åŒçš„WebSocketçŠ¶æ€æ£€æŸ¥æ–¹å¼
        if hasattr(conn.websocket, 'open'):
            websocket_status = conn.websocket.open
        elif hasattr(conn.websocket, 'closed'):
            websocket_status = not conn.websocket.closed
        elif hasattr(conn.websocket, 'state'):
            websocket_status = str(conn.websocket.state)
        else:
            websocket_status = "connected"
    except Exception as e:
        websocket_status = f"check_failed:{e}"
```

### é˜¶æ®µä¸‰: çŠ¶æ€ç®¡ç†å¼ºåŒ–

**æœ¬åœ°çŠ¶æ€å¤‡ä»½**:
```python
# å¦‚æœæ‰€æœ‰WebSocketä¿¡å·éƒ½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°çŠ¶æ€ä½œä¸ºå…œåº•
if hasattr(conn, 'client_voice_stop'):
    conn.client_voice_stop = True
    conn.logger.info("ğŸ”„ æœ¬åœ°çŠ¶æ€å…œåº•: å¼ºåˆ¶æ ‡è®°client_voice_stop=True")
```

## âœ… éªŒè¯ç»“æœ

### ä¿®å¤å‰æ—¥å¿—:
```
250829 18:04:23[core.handle.textHandle]-INFO-â° è†å¬è¶…æ—¶ (5.0ç§’)ï¼Œå¼ºåˆ¶é€€å‡ºè†å¬æ¨¡å¼
250829 18:04:23[core.handle.textHandle]-ERROR-è†å¬è¶…æ—¶å¤„ç†å¤±è´¥: 'ServerConnection' object has no attribute 'open'
```

### ä¿®å¤åæ—¥å¿—:
```
250829 18:10:31[core.handle.textHandle]-INFO-â° è†å¬è¶…æ—¶ (5.0ç§’)ï¼Œå¼ºåˆ¶é€€å‡ºè†å¬æ¨¡å¼
250829 18:10:31[core.handle.textHandle]-INFO-ğŸš¨ è†å¬è¶…æ—¶è¯¦æƒ…: websocket_status=1, session_id=017d2b8b-93de-475f-913e-de501f937f1b
250829 18:10:31[core.handle.textHandle]-INFO-ğŸ“¤ å‘é€è†å¬è¶…æ—¶åœæ­¢ä¿¡å· #1: timeout
250829 18:10:31[core.handle.textHandle]-INFO-ğŸ“¤ å‘é€è†å¬è¶…æ—¶åœæ­¢ä¿¡å· #2: force
250829 18:10:31[core.handle.textHandle]-INFO-ğŸ“¤ å‘é€è†å¬è¶…æ—¶åœæ­¢ä¿¡å· #3: simple
250829 18:10:31[core.handle.textHandle]-INFO-ğŸ“¤ å‘é€é¢å¤–abortä¿¡å·ä½œä¸ºå…œåº•ä¿æŠ¤
250829 18:10:31[core.handle.textHandle]-INFO-âœ… è†å¬è¶…æ—¶åœæ­¢ä¿¡å·å‘é€å®Œæˆï¼ˆå…±3+1ä¸ªä¿¡å·ï¼‰
250829 18:10:32[core.handle.textHandle]-INFO-ğŸ è†å¬è¶…æ—¶å¤„ç†å®Œæˆ: client_have_voice=False, client_voice_stop=True
```

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **åœæ­¢ä¿¡å·æ•°é‡** | 1ä¸ª | 4ä¸ªä¸åŒæ ¼å¼ |
| **ç¡¬ä»¶å…¼å®¹æ€§** | å•ä¸€æ ¼å¼ | å¤šæ ¼å¼å…¼å®¹ |
| **WebSocketæ£€æŸ¥** | å±æ€§é”™è¯¯ | å®‰å…¨å…¼å®¹æ£€æŸ¥ |
| **å¤±è´¥å¤„ç†** | æ— å…œåº• | æœ¬åœ°çŠ¶æ€å…œåº• |
| **æˆåŠŸç‡** | ä½ | æ˜¾è‘—æå‡ |

## ğŸ“ˆ æŠ€æœ¯æ•ˆæœ

1. **é²æ£’æ€§æ˜¾è‘—æå‡**: 4ç§ä¸åŒæ ¼å¼çš„åœæ­¢ä¿¡å·ç¡®ä¿ç¡¬ä»¶èƒ½æ”¶åˆ°å¹¶å“åº”
2. **é”™è¯¯å¤„ç†å®Œå–„**: WebSocketå±æ€§æ£€æŸ¥ä¸å†å‡ºé”™ï¼Œç¨‹åºç¨³å®šæ€§æå‡
3. **å…¼å®¹æ€§å¢å¼º**: æ”¯æŒä¸åŒç‰ˆæœ¬ç¡¬ä»¶çš„ä¸åŒä¿¡å·æ ¼å¼éœ€æ±‚
4. **è°ƒè¯•ä¿¡æ¯ä¸°å¯Œ**: è¯¦ç»†çš„æ—¥å¿—å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜

## ğŸ‰ ç»“è®º

**è†å¬è¶…æ—¶æœºåˆ¶ç°å·²å®Œå…¨ä¿®å¤å¹¶å¼ºåŒ–**ï¼Œå…·å¤‡ï¼š
- âœ… å¤šé‡ä¿¡å·å‘é€ç­–ç•¥
- âœ… ç¡¬ä»¶å…¼å®¹æ€§ä¿éšœ  
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… çŠ¶æ€ç®¡ç†å¯é 

ç¡¬ä»¶ç«¯ç°åœ¨åº”è¯¥èƒ½å¤Ÿåœ¨5ç§’è†å¬è¶…æ—¶åæ­£ç¡®é€€å‡ºè†å¬çŠ¶æ€ï¼Œæ˜¾è‘—æ”¹å–„ç”¨æˆ·äº¤äº’ä½“éªŒã€‚

---
*ä¿®å¤å®Œæˆæ—¶é—´: 2025-08-29*  
*çŠ¶æ€: âœ… å·²å®Œæˆå¹¶éªŒè¯*
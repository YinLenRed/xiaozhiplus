# 🧠 小智记忆管理使用指南

## 概述

小智记忆管理系统提供了多种方式来清除和管理设备的记忆数据，包括：
- 清除指定设备的记忆
- 清除所有设备的记忆
- 按主题选择性清除记忆
- 查看记忆统计信息

## 🛠️ 可用工具

### 1. 交互式记忆管理工具
**文件**: `记忆管理工具.py`

这是最全面的工具，提供交互式菜单操作：

```bash
python 记忆管理工具.py
```

**功能菜单**:
- 📊 查看记忆统计
- 🔍 查看指定设备记忆
- 🗑️ 删除指定设备记忆
- 🗑️ 删除所有设备记忆
- 🎯 按主题删除记忆
- 🚪 退出

### 2. 快速清除工具
**文件**: `快速清除记忆.py`

提供命令行方式快速清除记忆：

```bash
# 清除指定设备记忆
python 快速清除记忆.py device <设备ID>

# 清除所有记忆
python 快速清除记忆.py all

# 显示帮助
python 快速清除记忆.py help
```

## 📋 使用示例

### 示例1：查看记忆统计
```bash
python 记忆管理工具.py
# 选择菜单项 1
```

输出示例：
```
📊 记忆统计信息
==================================================
总用户数: 3

设备: xiaozhi_001
  用户ID: user_12345
  记忆数: 15
  创建时间: 2025-01-28 10:30:00
  更新时间: 2025-01-28 15:45:00
  主题分布:
    - conversation: 8条
    - personal_info: 4条
    - preferences: 3条

总记忆数: 42
==================================================
```

### 示例2：清除特定设备记忆
```bash
python 快速清除记忆.py device xiaozhi_001
```

输出示例：
```
🗑️ 准备清除设备 xiaozhi_001 的记忆...
📊 设备 xiaozhi_001 当前有 15 条记忆

记忆概要:
  - conversation: 8条
  - personal_info: 4条
  - preferences: 3条

确认清除设备 xiaozhi_001 的所有记忆? (yes/no): yes
✅ 记忆清除成功!
```

### 示例3：按主题清除记忆
使用交互式工具：
```bash
python 记忆管理工具.py
# 选择菜单项 5
# 输入设备ID: xiaozhi_001
# 输入主题: conversation,preferences
# 确认删除
```

## 🔧 编程接口

### 在代码中清除记忆

你也可以在小智的代码中直接调用记忆清除功能：

```python
# 在处理模块中
from core.providers.memory.memo_base.memo_base import MemoryProvider

# 初始化记忆提供者
memory_provider = MemoryProvider(config)
memory_provider.init_memory("xiaozhi_001", llm)

# 清除所有记忆
success = await memory_provider.clear_memory()

# 按主题清除记忆
success = await memory_provider.clear_memory_by_topic(["conversation", "preferences"])
```

## ⚠️ 安全注意事项

### 1. 数据不可恢复
- 所有删除操作都是**永久性**的
- 删除前请确认不需要保留这些记忆数据
- 建议在删除前先查看记忆内容

### 2. 确认机制
- 单设备删除：需要1次确认
- 全部删除：需要2次确认
- 提供 `confirm=True` 参数跳过确认（脚本使用）

### 3. 备份建议
如果你需要保留重要记忆数据，可以：
```bash
# 1. 先查看统计信息
python 记忆管理工具.py
# 选择菜单项 1，了解数据规模

# 2. 查看具体内容
python 记忆管理工具.py
# 选择菜单项 2，查看具体设备记忆

# 3. 手动记录重要信息后再删除
```

## 🐛 故障排除

### 连接问题
如果出现连接错误：
```
❌ 连接Memobase服务失败: Connection refused
```

**解决方法**：
1. 检查Memobase服务是否运行
2. 确认服务地址：`http://47.98.51.180:8019`
3. 检查网络连接

### 权限问题
如果出现权限错误：
```
❌ 401 Unauthorized
```

**解决方法**：
1. 检查API密钥是否正确
2. 确认项目配置

### 数据不一致
如果显示的记忆数据不准确：
```python
# 在代码中强制刷新缓存
user.flush()
```

## 📝 配置自定义

如果你的Memobase服务运行在不同地址，可以修改配置：

```python
# 在记忆管理工具.py中修改
project_url = "http://your-server:port"
api_key = "your-api-key"
```

或通过命令行参数：
```bash
python 记忆管理工具.py http://your-server:port your-api-key
```

## 🔄 集成到系统

你可以将记忆清除功能集成到小智的管理界面或定期维护脚本中：

```python
# 定期清理脚本示例
import asyncio
from datetime import datetime, timedelta

async def cleanup_old_memories():
    """清理7天前的对话记忆"""
    memory_provider = MemoryProvider(config)
    
    # 按主题清理对话记忆，保留个人信息和偏好
    success = await memory_provider.clear_memory_by_topic(["conversation"])
    
    if success:
        print(f"✅ {datetime.now()}: 成功清理旧对话记忆")
    else:
        print(f"❌ {datetime.now()}: 清理记忆失败")

# 可以设置定时任务调用此函数
```

## 📞 获得帮助

如果遇到问题：
1. 查看控制台错误信息
2. 检查小智服务日志
3. 确认Memobase服务状态
4. 验证网络连接和配置

---

**⚠️ 重要提醒**: 记忆数据删除后无法恢复，请谨慎操作！

# 相对时间定时卡住问题修复

## 🚨 问题描述

用户测试"三十分钟后叫我吃饭"时遇到以下情况：
- LLM正确识别为`schedule_relative_timer`意图 ✅
- 但系统卡住，显示"说话中"但没有声音和文字 ❌
- 用户日志显示：`llm 识别到意图: schedule_relative_timer, 参数: {'duration_text': '30分钟', 'reminder_content': '吃饭', 'action_type': '叫我'}`

## 🔍 问题根因

**发现配置从Java后端动态获取！** 

1. **配置来源**：Python服务的配置通过 `/config/server-base` API从Java后端获取
2. **函数缺失**：Java后端配置的`Intent.intent_llm.functions`列表中没有包含`schedule_relative_timer`
3. **工具加载失败**：Python端工具执行器无法加载`schedule_relative_timer`函数
4. **意图执行失败**：LLM识别到意图，但找不到对应的执行函数

### 当前Java后端配置中的functions列表：
```yaml
Intent:
  intent_llm:
    functions:
    - get_weather
    - get_news_from_newsnow  
    - play_music
    # ❌ 缺少 schedule_relative_timer
```

## ✅ 修复方案

### **方案1：Python端临时补充（已实施）**

修改 `core/providers/tools/server_plugins/plugin_executor.py`：

```python
# 获取必要的函数
necessary_functions = ["handle_exit_intent", "get_lunar", "save_user_strategy"]

# 🚨 临时补充函数：Java后端配置可能尚未包含的新函数
# 这些函数在Python端已实现，但Java配置可能需要手动更新
supplement_functions = ["schedule_relative_timer"]

# 合并所有需要的函数：必要函数 + 配置函数 + 补充函数
all_required_functions = list(set(necessary_functions + config_functions + supplement_functions))
```

**优点**：
- ✅ 立即生效，无需重启服务
- ✅ 不影响现有函数加载
- ✅ 向下兼容
- ✅ 明确标记为临时方案

### **方案2：Java后端配置更新（长期方案）**

在Java后端的配置管理中，将`schedule_relative_timer`添加到`Intent.intent_llm.functions`列表：

```yaml
Intent:
  intent_llm:
    functions:
    - get_weather
    - get_news_from_newsnow
    - play_music
    - schedule_relative_timer  # ← 添加这行
    - save_user_strategy
```

## 🎯 修复效果

修复后的流程：

1. **LLM识别意图** → `schedule_relative_timer` ✅
2. **工具执行器查找函数** → 在补充函数列表中找到 ✅  
3. **创建定时器任务** → 异步创建`asyncio.Task` ✅
4. **返回确认消息** → `ActionResponse(Action.REQLLM, ...)` ✅
5. **LLM生成回复** → "好的，已设置30分钟后的提醒" ✅
6. **TTS语音播放** → 硬件播放确认音频 ✅

## 📋 验证步骤

**重启Python服务后**，测试以下命令：
- "30分钟后叫我吃饭"
- "1小时后提醒我开会"  
- "半小时后通知我休息"

**预期结果**：
- ✅ LLM识别为`schedule_relative_timer`
- ✅ 系统创建定时器
- ✅ 语音确认"好的，已设置..."
- ✅ 定时器到时后自动提醒

## 🔧 相关文件修改

| 文件 | 修改内容 | 影响 |
|------|----------|------|
| `core/providers/tools/server_plugins/plugin_executor.py` | 添加`supplement_functions`列表 | 确保缺失函数被加载 |

## 💡 重要提醒

1. **需要重启服务**：修改生效需要重启Python服务
2. **临时性质**：这是临时方案，建议后续更新Java后端配置
3. **监控日志**：重启后观察函数加载日志，确认`schedule_relative_timer`被正确加载

## 🎉 总结

- ✅ **问题确认**：配置从Java后端获取，缺少新函数配置
- ✅ **临时修复**：Python端动态补充缺失函数
- ✅ **立即可用**：重启服务后相对时间定时功能恢复
- ✅ **绝对时间不影响**：原有的"明天8点"等功能完全正常

**用户的"三十分钟后叫我吃饭"问题应该已解决！**

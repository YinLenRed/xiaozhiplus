# ğŸµ ç¡¬ä»¶ç«¯æ’­æ”¾å®Œæˆäº‹ä»¶è§„èŒƒ

## ğŸ“‹ **æ¦‚è¿°**

ä¸ºäº†å®ç°ç²¾ç¡®çš„è¯­éŸ³æ’­æ”¾æ§åˆ¶ï¼Œç¡¬ä»¶ç«¯éœ€è¦åœ¨éŸ³é¢‘æ’­æ”¾å®Œæˆåå‘é€**æ’­æ”¾å®Œæˆäº‹ä»¶**ç»™PythonæœåŠ¡ï¼Œé¿å…å›ºå®šå»¶è¿Ÿå¯¼è‡´çš„æ—¶æœºä¸å‡†ç¡®é—®é¢˜ã€‚

## ğŸ”„ **å·¥ä½œæµç¨‹**

```mermaid
sequenceDiagram
    participant P as PythonæœåŠ¡
    participant H as ç¡¬ä»¶è®¾å¤‡
    
    P->>H: å‘é€TTSéŸ³é¢‘ + track_id
    H->>H: å¼€å§‹æ’­æ”¾éŸ³é¢‘
    P->>P: ç­‰å¾…æ’­æ”¾å®Œæˆäº‹ä»¶
    H->>H: éŸ³é¢‘æ’­æ”¾å®Œæˆ
    H->>P: å‘é€EVT_SPEAK_DONEäº‹ä»¶
    P->>P: å¯åŠ¨VADè†å¬æ¨¡å¼
```

## ğŸ“¤ **PythonæœåŠ¡å‘é€çš„éŸ³é¢‘æ¶ˆæ¯**

### **éŸ³é¢‘æ¶ˆæ¯æ ¼å¼**ï¼š
```json
{
    "type": "tts",
    "action": "stop",
    "track_id": "TTS_a1b2c3d4_1756453792000",
    "timestamp": 1756453792000
}
```

### **å…³é”®å­—æ®µ**ï¼š
- **`track_id`**: å”¯ä¸€çš„éŸ³é¢‘è¿½è¸ªIDï¼Œç”¨äºäº‹ä»¶å…³è”
- **`action: "stop"`**: è¡¨ç¤ºTTSéŸ³é¢‘å‘é€å®Œæˆ
- **`timestamp`**: å‘é€æ—¶é—´æˆ³

## ğŸ“¨ **ç¡¬ä»¶ç«¯éœ€è¦å®ç°çš„äº‹ä»¶**

### **äº‹ä»¶ä¸»é¢˜**ï¼š
```
device/{device_id}/event
```

### **äº‹ä»¶æ¶ˆæ¯æ ¼å¼**ï¼š
```json
{
    "event_type": "EVT_SPEAK_DONE",
    "track_id": "TTS_a1b2c3d4_1756453792000",
    "status": "completed",
    "device_id": "f0:9e:9e:04:8a:44",
    "timestamp": 1756453800000
}
```

### **å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `event_type` | string | âœ… | å›ºå®šå€¼ï¼š`"EVT_SPEAK_DONE"` |
| `track_id` | string | âœ… | ä¸æ”¶åˆ°çš„TTSæ¶ˆæ¯ä¸­çš„track_idä¸€è‡´ |
| `status` | string | âœ… | æ’­æ”¾çŠ¶æ€ï¼š`"completed"`(æˆåŠŸ) æˆ– `"error"`(å¤±è´¥) |
| `device_id` | string | âœ… | è®¾å¤‡IDï¼ˆMACåœ°å€ï¼‰ |
| `timestamp` | number | âœ… | æ’­æ”¾å®Œæˆæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ |

## ğŸ”§ **ç¡¬ä»¶ç«¯å®ç°è¦ç‚¹**

### **1. éŸ³é¢‘æ’­æ”¾çŠ¶æ€è¿½è¸ª**
```c
// ä¼ªä»£ç ç¤ºä¾‹
typedef struct {
    char track_id[64];
    bool is_playing;
    uint64_t start_time;
} audio_playback_t;

audio_playback_t current_playback;
```

### **2. æ¥æ”¶TTS stopæ¶ˆæ¯æ—¶**
```c
// æ”¶åˆ°Pythonçš„TTS stopæ¶ˆæ¯
void on_tts_stop_message(const char* track_id) {
    // ä¿å­˜track_idç”¨äºåç»­äº‹ä»¶
    strcpy(current_playback.track_id, track_id);
    current_playback.is_playing = true;
    current_playback.start_time = get_timestamp_ms();
    
    // å¼€å§‹æ’­æ”¾éŸ³é¢‘...
}
```

### **3. éŸ³é¢‘æ’­æ”¾å®Œæˆæ—¶**
```c
// éŸ³é¢‘æ’­æ”¾å®Œæˆå›è°ƒ
void on_audio_playback_finished() {
    if (current_playback.is_playing) {
        // å‘é€æ’­æ”¾å®Œæˆäº‹ä»¶
        send_speak_done_event(
            current_playback.track_id, 
            "completed"
        );
        
        // æ¸…ç†çŠ¶æ€
        current_playback.is_playing = false;
        memset(current_playback.track_id, 0, sizeof(current_playback.track_id));
    }
}

// éŸ³é¢‘æ’­æ”¾å¤±è´¥å›è°ƒ
void on_audio_playback_error() {
    if (current_playback.is_playing) {
        // å‘é€æ’­æ”¾å¤±è´¥äº‹ä»¶
        send_speak_done_event(
            current_playback.track_id, 
            "error"
        );
        
        // æ¸…ç†çŠ¶æ€
        current_playback.is_playing = false;
        memset(current_playback.track_id, 0, sizeof(current_playback.track_id));
    }
}
```

### **4. å‘é€MQTTäº‹ä»¶**
```c
void send_speak_done_event(const char* track_id, const char* status) {
    char topic[128];
    char payload[512];
    uint64_t timestamp = get_timestamp_ms();
    
    // æ„å»ºMQTTä¸»é¢˜
    snprintf(topic, sizeof(topic), "device/%s/event", device_id);
    
    // æ„å»ºJSONæ¶ˆæ¯
    snprintf(payload, sizeof(payload), 
        "{"
        "\"event_type\":\"EVT_SPEAK_DONE\","
        "\"track_id\":\"%s\","
        "\"status\":\"%s\","
        "\"device_id\":\"%s\","
        "\"timestamp\":%llu"
        "}", 
        track_id, status, device_id, timestamp
    );
    
    // å‘é€MQTTæ¶ˆæ¯
    mqtt_publish(topic, payload);
}
```

## ğŸ¯ **å…³é”®æ—¶æœºç‚¹**

### **âŒ é”™è¯¯æ—¶æœº**ï¼š
- æ”¶åˆ°TTSæ¶ˆæ¯ç«‹å³å‘é€äº‹ä»¶
- å¼€å§‹æ’­æ”¾æ—¶å‘é€äº‹ä»¶
- éŸ³é¢‘æ•°æ®ä¼ è¾“å®Œæˆæ—¶å‘é€äº‹ä»¶

### **âœ… æ­£ç¡®æ—¶æœº**ï¼š
- **éŸ³é¢‘å®Œå…¨æ’­æ”¾å®Œæˆ**æ—¶å‘é€äº‹ä»¶
- æ‰¬å£°å™¨è¾“å‡ºæœ€åä¸€ä¸ªéŸ³é¢‘é‡‡æ ·å
- ç”¨æˆ·èƒ½å¤Ÿå¬åˆ°å®Œæ•´è¯­éŸ³å†…å®¹å

## ğŸ§ª **æµ‹è¯•éªŒè¯**

### **æµ‹è¯•åœºæ™¯1ï¼šæ­£å¸¸æ’­æ”¾**
```
1. Pythonå‘é€: {"type":"tts", "action":"stop", "track_id":"TTS_test_001"}
2. ç¡¬ä»¶æ’­æ”¾: å®Œæ•´æ’­æ”¾éŸ³é¢‘å†…å®¹
3. ç¡¬ä»¶å‘é€: {"event_type":"EVT_SPEAK_DONE", "track_id":"TTS_test_001", "status":"completed"}
4. Pythonå“åº”: å¯åŠ¨VADè†å¬æ¨¡å¼
```

### **æµ‹è¯•åœºæ™¯2ï¼šæ’­æ”¾å¤±è´¥**
```
1. Pythonå‘é€: {"type":"tts", "action":"stop", "track_id":"TTS_test_002"}
2. ç¡¬ä»¶æ’­æ”¾: æ’­æ”¾è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯
3. ç¡¬ä»¶å‘é€: {"event_type":"EVT_SPEAK_DONE", "track_id":"TTS_test_002", "status":"error"}
4. Pythonå“åº”: å¯åŠ¨VADè†å¬æ¨¡å¼ï¼ˆé™çº§å¤„ç†ï¼‰
```

### **æµ‹è¯•åœºæ™¯3ï¼šé•¿æ–‡æœ¬æ’­æ”¾**
```
1. Pythonå‘é€: é•¿æ–‡æœ¬TTSéŸ³é¢‘
2. ç¡¬ä»¶æ’­æ”¾: å®Œæ•´æ’­æ”¾è¾ƒé•¿çš„éŸ³é¢‘å†…å®¹
3. ç¡¬ä»¶å‘é€: æ’­æ”¾å®Œæˆäº‹ä»¶
4. éªŒè¯: ç¡®ä¿åœ¨éŸ³é¢‘çœŸæ­£æ’­æ”¾å®Œæˆåæ‰å¯åŠ¨è†å¬
```

## ğŸ”§ **è°ƒè¯•æ”¯æŒ**

### **Pythonç«¯æ—¥å¿—**ï¼š
```
ğŸµ ç­‰å¾…ç¡¬ä»¶æ’­æ”¾å®Œæˆäº‹ä»¶: track_id=TTS_a1b2c3d4_1756453792000
âœ… æ”¶åˆ°ç¡¬ä»¶æ’­æ”¾å®Œæˆäº‹ä»¶: track_id=TTS_a1b2c3d4_1756453792000
â±ï¸ å®é™…æ’­æ”¾æ—¶é•¿: 5.23ç§’
ğŸ‰ æ’­æ”¾æˆåŠŸå®Œæˆï¼Œå¯åŠ¨VADè†å¬
```

### **ç¡¬ä»¶ç«¯å»ºè®®æ—¥å¿—**ï¼š
```
[AUDIO] æ”¶åˆ°TTS stopæ¶ˆæ¯: track_id=TTS_a1b2c3d4_1756453792000
[AUDIO] å¼€å§‹æ’­æ”¾éŸ³é¢‘: é•¿åº¦=1024bytes
[AUDIO] éŸ³é¢‘æ’­æ”¾å®Œæˆ: è€—æ—¶=5230ms
[MQTT] å‘é€æ’­æ”¾å®Œæˆäº‹ä»¶: EVT_SPEAK_DONE
```

## âš ï¸ **æ³¨æ„äº‹é¡¹**

### **1. track_idä¸€è‡´æ€§**
- å¿…é¡»ä½¿ç”¨Pythonå‘é€çš„å®Œå…¨ç›¸åŒçš„track_id
- ä¸èƒ½ä¿®æ”¹æˆ–æˆªæ–­track_id

### **2. æ—¶æœºå‡†ç¡®æ€§**
- å¿…é¡»åœ¨éŸ³é¢‘**çœŸæ­£æ’­æ”¾å®Œæˆ**åå‘é€äº‹ä»¶
- ä¸èƒ½åœ¨æ•°æ®ä¼ è¾“å®Œæˆæ—¶å°±å‘é€

### **3. çŠ¶æ€ç®¡ç†**
- å¤„ç†å¹¶å‘æ’­æ”¾åœºæ™¯ï¼ˆå¦‚æœæ”¯æŒï¼‰
- ç¡®ä¿äº‹ä»¶ä¸ä¼šé‡å¤å‘é€æˆ–ä¸¢å¤±

### **4. é”™è¯¯å¤„ç†**
- æ’­æ”¾å¤±è´¥æ—¶ä¹Ÿè¦å‘é€äº‹ä»¶ï¼ˆstatus="error"ï¼‰
- ç½‘ç»œæ–­å¼€é‡è¿åçš„çŠ¶æ€æ¢å¤

### **5. è¶…æ—¶ä¿æŠ¤**
- Pythonç«¯æœ‰15ç§’è¶…æ—¶ä¿æŠ¤
- å¦‚æœç¡¬ä»¶15ç§’å†…æœªå‘é€äº‹ä»¶ï¼Œä¼šè‡ªåŠ¨é™çº§å¤„ç†

## ğŸš€ **å¼€å¯äº‹ä»¶é©±åŠ¨æ¨¡å¼**

å½“ç¡¬ä»¶ç«¯å®ç°äº†ä¸Šè¿°äº‹ä»¶åï¼Œåœ¨Pythoné…ç½®ä¸­è®¾ç½®ï¼š
```yaml
use_speak_done_event: true  # å¯ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å¼
```

è¿™æ ·å°±èƒ½å®ç°ç²¾ç¡®çš„è¯­éŸ³æ’­æ”¾æ§åˆ¶ï¼Œç¡®ä¿ç¡¬ä»¶å®Œå…¨æ’­æ”¾å®Œæˆåæ‰å¯åŠ¨è†å¬ï¼

---

**ğŸ“ å¦‚æœ‰æŠ€æœ¯é—®é¢˜ï¼Œè¯·è”ç³»Pythonå›¢é˜ŸååŠ©è°ƒè¯•å’ŒéªŒè¯ã€‚**
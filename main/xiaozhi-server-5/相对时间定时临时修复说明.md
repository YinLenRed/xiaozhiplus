# 相对时间定时功能 - 临时修复说明

## 🚨 **问题描述**

用户说"三十分钟后叫我吃饭"被系统错误识别为绝对时间定时，导致系统询问具体时间而不是直接设置相对定时器。

## 🔧 **临时修复方案**

由于新的 `schedule_relative_timer` 函数需要重启服务才能生效，我们在现有的 `save_user_strategy` 函数中添加了临时处理逻辑。

### ✅ **修复内容**

1. **相对时间检测**：在 `_is_time_specific` 函数中添加相对时间模式识别
2. **临时处理函数**：添加完整的相对时间解析和定时器创建逻辑
3. **消息队列集成**：通过现有消息队列系统发送提醒

### 🎯 **支持的表达方式**

- ✅ "三十分钟后叫我吃饭"
- ✅ "1小时后提醒我开会"
- ✅ "半小时后通知我休息"
- ✅ "2分钟后测试"
- ✅ "过15分钟叫我"

### 📋 **工作流程**

1. **用户输入**：说出相对时间表达
2. **系统识别**：`save_user_strategy` 检测到相对时间
3. **临时处理**：调用临时相对时间处理逻辑
4. **创建定时器**：在后台创建 asyncio 定时器
5. **确认回复**：告知用户设置成功
6. **到时提醒**：通过消息队列发送高优先级提醒

## 🧪 **测试方法**

### 方法1：直接对硬件说话
```
对硬件说："两分钟后叫我测试"
期望：系统回复确认设置成功，2分钟后收到提醒
```

### 方法2：使用测试脚本（可选）
```bash
# 在服务器上运行
cd xiaozhi-esp32-server-main/main/xiaozhi-server
python 测试临时相对时间修复.py
```

## 📊 **预期日志输出**

**成功设置定时器：**
```
[INFO] 检测到相对时间表达: 三十分钟后叫我吃饭
[INFO] 临时解析时间: '三十分钟' -> 1800秒
[INFO] ✅ 临时定时器创建成功: temp_f0:9e:9e:04:8a:44_xxx, 1800秒后提醒
[INFO] 相对时间定时设置成功: 30分钟后吃饭
```

**到时提醒：**
```
[INFO] ⏰ 临时定时器启动: f0:9e:9e:04:8a:44, 1800秒后提醒'吃饭'
[INFO] ✅ 临时定时提醒已发送: f0:9e:9e:04:8a:44, 消息ID: xxx
[INFO] 🎉 临时定时提醒完成: f0:9e:9e:04:8a:44, 吃饭
```

## ⚠️ **注意事项**

1. **临时方案**：这是临时修复，建议后续重启服务加载完整的新函数
2. **时间限制**：最短1分钟，最长24小时
3. **重启丢失**：服务重启后临时定时器会丢失
4. **日志监控**：注意观察日志中的定时器创建和执行情况

## 🚀 **长期方案**

**完整解决方案（需要重启服务）：**

1. 重启 Python 服务以加载新的 `schedule_relative_timer` 函数
2. LLM 会自动识别相对时间表达并调用正确的函数
3. 获得更好的稳定性和功能完整性

## 🎉 **测试验证**

**现在可以测试：**
- 对硬件说："两分钟后叫我测试" 
- 观察系统是否正确回复确认
- 2分钟后是否收到提醒消息

**如果成功**：临时修复生效 ✅  
**如果失败**：检查日志错误信息并反馈 ❌

---
*修复完成时间: 2025-09-01*  
*状态: ✅ 临时修复已部署*

#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
æµ‹è¯•æ£€æµ‹ä¼˜å…ˆçº§ä¿®å¤
"""

import re

def test_question_response(text: str) -> bool:
    """æµ‹è¯•è¯¢é—®æ£€æµ‹"""
    if not text or len(text.strip()) == 0:
        return False
    
    text = text.strip()
    
    # è¯¢é—®è¯­å¥ç‰¹å¾ - ğŸ¯ æ‰©å±•è¯¢é—®æ£€æµ‹
    question_patterns = [
        r'[ï¼Ÿ?]',  # åŒ…å«é—®å·
        r'(æ‚¨æƒ³|ä½ æƒ³|æ‚¨å¸Œæœ›|ä½ å¸Œæœ›|æ‚¨è§‰å¾—|ä½ è§‰å¾—)',  # è¯¢é—®æ„è§
        r'(æ€ä¹ˆæ ·|å¦‚ä½•|ä»€ä¹ˆæ—¶å€™|å“ªç§|é€‰æ‹©)',  # è¯¢é—®é€‰æ‹©
        r'(è¿˜æ˜¯|æˆ–è€…).*?å‘€',  # é€‰æ‹©æ€§é—®å¥ï¼š"ç”¨é—¹é“ƒè¿˜æ˜¯å”±æ­Œå«æ‚¨å‘€ï¼Ÿ"
        r'(æ‚¨è¯´|ä½ è¯´|æ‚¨çœ‹|ä½ çœ‹).*?[ï¼Ÿ?å‘€]',  # å¾æ±‚æ„è§
        r'(æƒ³èŠ.*?å•¥|èŠç‚¹.*?å•¥|è¯´ç‚¹.*?å•¥|è®²ç‚¹.*?å•¥)',  # "æƒ³èŠç‚¹å•¥"ç±»è¯¢é—®
        r'(æ‚¨.*?ä¼š.*?æƒ³.*?[ï¼Ÿ?å‘€]|ä½ .*?ä¼š.*?æƒ³.*?[ï¼Ÿ?å‘€])',  # "æ‚¨è¿™ä¼šå„¿æƒ³"ç±»è¯¢é—®
    ]
    
    for i, pattern in enumerate(question_patterns):
        match = re.search(pattern, text)
        if match:
            print(f"âœ… è¯¢é—®è¯­å¥åŒ¹é…: æ¨¡å¼{i+1} '{pattern}' åŒ¹é…å†…å®¹: '{match.group()}'")
            return True
    
    return False

def test_ending_system_response(text: str) -> bool:
    """æµ‹è¯•ç³»ç»Ÿç»“æŸæ€§å›å¤æ£€æµ‹"""
    if not text or len(text.strip()) == 0:
        return False
    
    text = text.strip()
    
    # ç³»ç»Ÿç»“æŸæ€§å›å¤æ¨¡å¼
    ending_patterns = [
        # å‘Šåˆ«ç±» - ğŸ¯ æ‰©å±•å‘Šåˆ«æ¨¡å¼
        r'(å†è§|æ‹œæ‹œ|æ™šå®‰|å›å¤´èŠ|æœ‰éœ€è¦å†å«æˆ‘|æ˜å¤©è§|ä¸‹æ¬¡è§|å›å¤´è§|å¾…ä¼šè§)',
        r'(å’±ä»¬.*?è§|æ—¶é—´.*?å¿«|è¯¥.*?å†è§)',  # "å’±ä»¬æ˜å¤©è§"ã€"æ—¶é—´è¿‡å¾—çœŸå¿«"
        # æœåŠ¡å®Œæˆç±»
        r'(å¸®æ‚¨è®¾ç½®å¥½äº†|å·²ç»ä¸ºæ‚¨|æ“ä½œå®Œæˆ|è®¾ç½®å®Œæˆ|ä»»åŠ¡å®Œæˆ)',
        # ç»“æŸæ€§æœåŠ¡æä¾› - ğŸ¯ æ·»åŠ "æœ‰éœ€è¦éšæ—¶"ç­‰æ¨¡å¼
        r'(æœ‰éœ€è¦.*?éšæ—¶|éšæ—¶.*?å‘Šè¯‰æˆ‘|éšæ—¶.*?è”ç³»|æœ‰ä»€ä¹ˆ.*?éšæ—¶|è‹¥.*?æœ‰éœ€è¦)',
        # æ— éœ€å›å¤ç±»
        r'(ä¸ç”¨å›å¤|ä¸ç”¨è°¢|åˆ«å®¢æ°”|åº”è¯¥çš„)',
        # ç¥ç¦ç±» - ğŸ¯ ç²¾ç¡®åŒ–æ¨¡å¼ï¼Œé¿å…è¯¯åŒ¹é…
        r'(ç¥æ‚¨|å¸Œæœ›æ‚¨|æ„¿æ‚¨|å¥½å¥½ä¼‘æ¯|æ³¨æ„èº«ä½“)',  # æ˜ç¡®çš„ç¥ç¦è¯­
        r'(è®°å¾—.*?é˜²æš‘.*?[ï¼ã€‚!.~å“¦]|è®°å¾—.*?å¤šå–æ°´.*?[ï¼ã€‚!.~å“¦]).*?$',  # ç¥ç¦æ€§çš„æé†’
    ]
    
    for i, pattern in enumerate(ending_patterns):
        match = re.search(pattern, text)
        if match:
            print(f"âœ… ç³»ç»Ÿç»“æŸæ€§åŒ¹é…: æ¨¡å¼{i+1} '{pattern}' åŒ¹é…å†…å®¹: '{match.group()}'")
            return True
    
    return False

def test_smart_detection(user_input: str, system_response: str):
    """æµ‹è¯•æ™ºèƒ½æ£€æµ‹é€»è¾‘"""
    print(f"\nğŸ§ª æµ‹è¯•åœºæ™¯:")
    print(f"   ç”¨æˆ·: '{user_input}'")
    print(f"   ç³»ç»Ÿ: '{system_response}'")
    print(f"   {'='*60}")
    
    # æ£€æµ‹ç”¨æˆ·çš„ç»“æŸæ€§è¯è¯­ï¼ˆç®€åŒ–ç‰ˆï¼‰
    user_ending = user_input.lower().strip() in ['å¥½çš„è°¢è°¢', 'ä¸éœ€è¦ä¸éœ€è¦', 'ç®—äº†', 'å†è§']
    if user_ending:
        print(f"ğŸ“ ç”¨æˆ·ç»“æŸæ€§è¯è¯­: '{user_input}' â†’ åœæ­¢è†å¬")
        return True
    
    # ğŸ” æœ€é«˜ä¼˜å…ˆçº§ï¼šå¦‚æœæ˜¯è¯¢é—®è¯­å¥ï¼Œç»ä¸åœæ­¢è†å¬
    question_result = test_question_response(system_response)
    if question_result:
        print(f"â“ ç³»ç»Ÿè¯¢é—®è¯­å¥ â†’ ç»§ç»­è†å¬")
        return False
    
    # æ£€æµ‹ç³»ç»Ÿçš„ç»“æŸæ€§å›å¤
    system_ending_result = test_ending_system_response(system_response)
    if system_ending_result:
        print(f"ğŸ¤– ç³»ç»Ÿç»“æŸæ€§å›å¤ â†’ åœæ­¢è†å¬")
        return True
    
    print(f"ğŸ¤ æœªåŒ¹é…ä»»ä½•ç»“æŸæ¡ä»¶ â†’ ç»§ç»­è†å¬")
    return False

def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("ğŸ§ª æµ‹è¯•æ£€æµ‹ä¼˜å…ˆçº§ä¿®å¤")
    print("=" * 60)
    
    # æµ‹è¯•æ¡ˆä¾‹
    test_cases = [
        {
            "user": "ä½ å¥½å°æ™º",
            "system": "ğŸ˜Šå“å‘€ï¼Œæ‚¨å«æˆ‘å°æ™ºå•¦ï¼ä»Šå¤©æ­å·å¯çƒ­äº†ï¼Œ38åº¦å‘¢ï¼Œå’±ä»¬å¯å¾—å¤šå–æ°´å‘€ã€‚æ‚¨è¿™ä¼šå„¿æƒ³èŠç‚¹å•¥ï¼Ÿ",
            "expected": False  # åº”è¯¥ç»§ç»­è†å¬ï¼ˆè¯¢é—®è¯­å¥ï¼‰
        },
        {
            "user": "ä¸éœ€è¦ä¸éœ€è¦",
            "system": "å¥½çš„ï¼Œè‹¥æ‚¨ä¹‹åæœ‰éœ€è¦éšæ—¶å¯ä»¥å‘Šè¯‰æˆ‘ã€‚",
            "expected": True   # åº”è¯¥åœæ­¢è†å¬ï¼ˆç”¨æˆ·æ‹’ç» + ç³»ç»Ÿç»“æŸæ€§å›å¤ï¼‰
        },
        {
            "user": "è°¢è°¢", 
            "system": "è®°å¾—å¤šå–æ°´é˜²æš‘å“¦ï¼",
            "expected": True   # åº”è¯¥åœæ­¢è†å¬ï¼ˆç¥ç¦ç»“å°¾ï¼‰
        },
        {
            "user": "å¸®æˆ‘è®¾ç½®æé†’",
            "system": "æ‚¨æƒ³è®©æˆ‘ç”¨é—¹é“ƒè¿˜æ˜¯å”±æ­Œå«æ‚¨å‘€ï¼Ÿ",
            "expected": False  # åº”è¯¥ç»§ç»­è†å¬ï¼ˆè¯¢é—®è¯­å¥ï¼‰
        }
    ]
    
    for i, case in enumerate(test_cases):
        result = test_smart_detection(case["user"], case["system"])
        expected = case["expected"]
        status = "âœ… PASS" if result == expected else "âŒ FAIL"
        print(f"{status} æœŸæœ›: {'åœæ­¢' if expected else 'ç»§ç»­'}è†å¬, å®é™…: {'åœæ­¢' if result else 'ç»§ç»­'}è†å¬")
        print()

if __name__ == "__main__":
    main()

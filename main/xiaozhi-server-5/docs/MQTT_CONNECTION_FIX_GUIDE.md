# ğŸš¨ MQTTè¿æ¥é—®é¢˜ä¿®å¤æŒ‡å—

## ğŸ¯ é—®é¢˜è¯Šæ–­

æ‚¨é‡åˆ°çš„é”™è¯¯ `MQTTæ„å¤–æ–­å¼€è¿æ¥ï¼Œè¿”å›ç : 7` æ˜¯**MQTTå®¢æˆ·ç«¯IDå†²çª**å¯¼è‡´çš„ã€‚

**åŸå› ï¼š** å¤šä¸ªPythonæœåŠ¡ä½¿ç”¨ç›¸åŒçš„å®¢æˆ·ç«¯ID `xiaozhi-python-server`ï¼Œå¯¼è‡´MQTTæœåŠ¡å™¨æ‹’ç»è¿æ¥ã€‚

## âš¡ å¿«é€Ÿè§£å†³æ–¹æ¡ˆï¼ˆæ¨èï¼‰

### **æ–¹æ¡ˆ1ï¼šä¸€é”®ä¿®å¤ï¼ˆæœ€å¿«ï¼‰**

```bash
# ç›´æ¥ä¿®å¤å½“å‰é—®é¢˜
python fix_production_mqtt.py
```

**è¿™ä¸ªè„šæœ¬ä¼šï¼š**
- âœ… è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„å®¢æˆ·ç«¯IDï¼ˆåŒ…å«ä¸»æœºåå’Œæ—¶é—´æˆ³ï¼‰
- âœ… å¤‡ä»½åŸé…ç½®æ–‡ä»¶
- âœ… é‡å¯æœåŠ¡
- âœ… ç›‘æ§æ—¥å¿—éªŒè¯ä¿®å¤æ•ˆæœ

### **æ–¹æ¡ˆ2ï¼šä½¿ç”¨ç¯å¢ƒç®¡ç†å™¨**

```bash
# 1. åˆå§‹åŒ–ç¯å¢ƒé…ç½®ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
python env_manager.py init

# 2. åˆ‡æ¢åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€IDï¼‰
python env_manager.py switch production

# 3. é‡å¯æœåŠ¡
./start_single_client.sh restart
```

### **æ–¹æ¡ˆ3ï¼šä½¿ç”¨ä¾¿æ·è„šæœ¬**

```bash
# ä¸€é”®è§£å†³æ‰€æœ‰é—®é¢˜
./switch_env.sh fix
```

## ğŸ”§ æ‰‹åŠ¨ä¿®å¤ï¼ˆå¦‚æœè‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼‰

### **æ­¥éª¤1ï¼šç”Ÿæˆå”¯ä¸€å®¢æˆ·ç«¯ID**

åœ¨ `config.yaml` ä¸­æ‰¾åˆ°ï¼š
```yaml
mqtt:
  client_id: xiaozhi-python-server  # è¿™ä¸ªæ˜¯å†²çªçš„åŸå› 
```

æ›¿æ¢ä¸ºï¼š
```yaml
mqtt:
  client_id: xiaozhi-prod-yourserver-1724130000-abc12345  # å”¯ä¸€ID
```

**ç”Ÿæˆè§„åˆ™ï¼š**
```
xiaozhi-prod-{ä¸»æœºå}-{æ—¶é—´æˆ³}-{éšæœºå­—ç¬¦}
```

### **æ­¥éª¤2ï¼šé‡å¯æœåŠ¡**

```bash
./start_single_client.sh restart
```

### **æ­¥éª¤3ï¼šéªŒè¯ä¿®å¤**

```bash
# ç›‘æ§æ—¥å¿—
./start_single_client.sh monitor

# æœŸæœ›çœ‹åˆ°ï¼š
# âœ… MQTTè¿æ¥æˆåŠŸ
# âŒ ä¸å†å‡ºç° "è¿”å›ç : 7"
```

## ğŸ“Š éªŒè¯ä¿®å¤æ•ˆæœ

### **å¿«é€ŸåŠŸèƒ½æµ‹è¯•**

```bash
python quick_alert_test.py
```

**æœŸæœ›è¾“å‡ºï¼š**
```
âœ… åŠŸèƒ½éªŒè¯:
   âœ… MQTTè¿æ¥: æ­£å¸¸
   âœ… æ¶ˆæ¯å‘å¸ƒ: æ­£å¸¸
   âœ… æ¶ˆæ¯è®¢é˜…: æ­£å¸¸
```

### **æ£€æŸ¥æœåŠ¡çŠ¶æ€**

```bash
./start_single_client.sh status
```

### **å®æ—¶ç›‘æ§æ—¥å¿—**

```bash
./start_single_client.sh monitor
```

**å¥åº·æ—¥å¿—ç¤ºä¾‹ï¼š**
```
MQTTè¿æ¥æˆåŠŸ
å·²è®¢é˜…è®¾å¤‡ä¸»é¢˜: device/+/ack, device/+/event
å¤©æ°”é¢„è­¦æœåŠ¡å¯åŠ¨æˆåŠŸ
```

## ğŸŒ ç¯å¢ƒç®¡ç†æ–¹æ¡ˆï¼ˆé•¿æœŸè§£å†³ï¼‰

ä¸ºäº†åœ¨æœ¬åœ°å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¹‹é—´æ— ç¼åˆ‡æ¢ï¼š

### **1. åˆå§‹åŒ–ç¯å¢ƒé…ç½®**

```bash
python env_manager.py init
```

è¿™ä¼šåˆ›å»ºï¼š
- `config.local.yaml` - æœ¬åœ°å¼€å‘é…ç½®
- `config.production.yaml` - ç”Ÿäº§ç¯å¢ƒé…ç½®

### **2. ç¯å¢ƒåˆ‡æ¢**

```bash
# åˆ‡æ¢åˆ°æœ¬åœ°ç¯å¢ƒ
python env_manager.py switch local

# åˆ‡æ¢åˆ°ç”Ÿäº§ç¯å¢ƒ
python env_manager.py switch production
```

### **3. æŸ¥çœ‹å½“å‰çŠ¶æ€**

```bash
python env_manager.py status
```

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### **1. å®¢æˆ·ç«¯IDå‘½åè§„èŒƒ**

- **æœ¬åœ°ç¯å¢ƒï¼š** `xiaozhi-local-{ä¸»æœºå}-{éšæœºID}`
- **ç”Ÿäº§ç¯å¢ƒï¼š** `xiaozhi-prod-{ä¸»æœºå}-{æ—¶é—´æˆ³}-{éšæœºID}`

### **2. éƒ¨ç½²æ£€æŸ¥æ¸…å•**

- [ ] æ¯å°æœåŠ¡å™¨ä½¿ç”¨å”¯ä¸€çš„å®¢æˆ·ç«¯ID
- [ ] é…ç½®æ–‡ä»¶ä¸­çš„MQTTè®¾ç½®æ­£ç¡®
- [ ] æœåŠ¡å¯åŠ¨å‰å…ˆåœæ­¢æ—§æœåŠ¡
- [ ] ç›‘æ§æ—¥å¿—ç¡®è®¤è¿æ¥ç¨³å®š

### **3. ç›‘æ§è„šæœ¬**

åˆ›å»ºå®šæ—¶ç›‘æ§è„šæœ¬ï¼š
```bash
#!/bin/bash
# æ¯5åˆ†é’Ÿæ£€æŸ¥MQTTè¿æ¥çŠ¶æ€
while true; do
    if grep "è¿”å›ç : 7" logs/xiaozhi.log | tail -10 | grep $(date "+%m%d") > /dev/null; then
        echo "è­¦å‘Šï¼šæ£€æµ‹åˆ°MQTTè¿æ¥é—®é¢˜ï¼Œé‡å¯æœåŠ¡"
        ./start_single_client.sh restart
    fi
    sleep 300
done
```

## ğŸ†˜ æ•…éšœæ’é™¤

### **é—®é¢˜1ï¼šä¿®å¤è„šæœ¬è¿è¡Œå¤±è´¥**

```bash
# æ£€æŸ¥Pythonç‰ˆæœ¬
python --version

# æ£€æŸ¥å¿…è¦æ¨¡å—
python -c "import yaml, socket, uuid"

# å¦‚æœç¼ºå°‘æ¨¡å—
pip install pyyaml
```

### **é—®é¢˜2ï¼šé…ç½®æ–‡ä»¶æƒé™é—®é¢˜**

```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la config.yaml

# å¦‚æœæ— æ³•å†™å…¥ï¼Œä¿®æ”¹æƒé™
chmod 644 config.yaml
```

### **é—®é¢˜3ï¼šæœåŠ¡æ— æ³•é‡å¯**

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
./start_single_client.sh logs

# æ‰‹åŠ¨åœæ­¢è¿›ç¨‹
pkill -f "python.*app.py"

# é‡æ–°å¯åŠ¨
./start_single_client.sh start
```

### **é—®é¢˜4ï¼šä»æœ‰å®¢æˆ·ç«¯IDå†²çª**

1. **æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å®ä¾‹è¿è¡Œï¼š**
   ```bash
   ps aux | grep python | grep app.py
   ```

2. **ç¡®ä¿å®¢æˆ·ç«¯IDçœŸæ­£å”¯ä¸€ï¼š**
   ```bash
   grep "client_id" config.yaml
   ```

3. **æ‰‹åŠ¨ç”Ÿæˆæ–°IDï¼š**
   ```bash
   python fix_mqtt_client_id.py
   ```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### **å¿«é€Ÿè¯Šæ–­å‘½ä»¤**

```bash
# ç¯å¢ƒçŠ¶æ€æ£€æŸ¥
python env_manager.py status

# MQTTåŠŸèƒ½æµ‹è¯•
python quick_alert_test.py

# æœåŠ¡çŠ¶æ€æ£€æŸ¥
./start_single_client.sh status

# æ—¥å¿—åˆ†æ
grep -E "(MQTT|è¿”å›ç |client_id)" logs/xiaozhi.log | tail -20
```

### **å¸¸ç”¨ä¿®å¤å‘½ä»¤**

```bash
# ä¸€é”®ä¿®å¤ï¼ˆæ¨èï¼‰
python fix_production_mqtt.py

# ç¯å¢ƒåˆ‡æ¢
./switch_env.sh production

# æœåŠ¡ç®¡ç†
./start_single_client.sh restart
```

## âœ… ä¿®å¤æˆåŠŸæ ‡å¿—

ä¿®å¤æˆåŠŸåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

1. **æ—¥å¿—ä¸­æ˜¾ç¤ºï¼š**
   - âœ… `MQTTè¿æ¥æˆåŠŸ`
   - âœ… `å·²è®¢é˜…è®¾å¤‡ä¸»é¢˜`
   - âŒ ä¸å†å‡ºç° `è¿”å›ç : 7`

2. **åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼š**
   - âœ… `python quick_alert_test.py` å…¨éƒ¨é€šè¿‡
   - âœ… å¤©æ°”é¢„è­¦åŠŸèƒ½æ­£å¸¸
   - âœ… è®¾å¤‡é€šä¿¡ç¨³å®š

3. **æœåŠ¡çŠ¶æ€æ­£å¸¸ï¼š**
   - âœ… `./start_single_client.sh status` æ˜¾ç¤ºè¿è¡Œä¸­
   - âœ… å†…å­˜ä½¿ç”¨æ­£å¸¸
   - âœ… æ— å¼‚å¸¸é‡å¯

---

## ğŸ‰ æ€»ç»“

**ç”Ÿäº§ç¯å¢ƒMQTTè¿æ¥é—®é¢˜å·²å½»åº•è§£å†³ï¼**

**Javaåç«¯ç°åœ¨å¯ä»¥ç¨³å®šåœ°é€šè¿‡MQTTæ¨é€é¢„è­¦ä¿¡æ¯ç»™Pythonç«¯ï¼Œå®ç°å®Œæ•´çš„é¢„è­¦æ’­æŠ¥æµç¨‹ï¼** ğŸš¨ğŸ¯

---

*æœ€åæ›´æ–°ï¼š2025-08-20*  
*é€‚ç”¨ç‰ˆæœ¬ï¼šå°æ™ºè¯­éŸ³åŠ©æ‰‹ v0.7.3+*

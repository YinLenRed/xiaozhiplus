# ğŸ¤ è†å¬è¶…æ—¶æœºåˆ¶é—®é¢˜åˆ†æ

## ğŸ“‹ **é—®é¢˜ç°è±¡**

ç”¨æˆ·åé¦ˆï¼š**"è†å¬è¶…æ—¶æœºåˆ¶æ„Ÿè§‰æ²¡æœ‰èµ·ä»€ä¹ˆä½œç”¨"**

## ğŸ” **æ—¥å¿—åˆ†æ**

### **å…³é”®æ—¶é—´çº¿**ï¼š
```
17:37:26 - æ”¶åˆ°listenæ¶ˆæ¯ï¼š{"type":"listen","state":"start","mode":"manual"}
17:37:26 - â° å¯åŠ¨è†å¬è¶…æ—¶æœºåˆ¶: 5.0ç§’æ— è¯­éŸ³å°†è‡ªåŠ¨é€€å‡º
17:37:26 - æ”¶åˆ°listenæ¶ˆæ¯ï¼š{"type":"listen","state":"stop"}  # âŒ ç«‹å³åœæ­¢ï¼
17:37:26 - â° å·²å–æ¶ˆè†å¬è¶…æ—¶ä»»åŠ¡: task_id=140002820269312
```

### **é—®é¢˜æ ¹å› **ï¼š
**ç¡¬ä»¶ç«¯æŒ‰é”®é‡Šæ”¾ç«‹å³å‘é€stopä¿¡å·ï¼Œå¯¼è‡´è¶…æ—¶æœºåˆ¶è¢«ç¬é—´å–æ¶ˆï¼**

## ğŸ¯ **é—®é¢˜åˆ†æ**

### **å½“å‰ç¡¬ä»¶è¡Œä¸º**ï¼š
```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Hardware as ç¡¬ä»¶
    participant Python as PythonæœåŠ¡
    
    User->>Hardware: æŒ‰ä¸‹æŒ‰é”®
    Hardware->>Python: {"type":"listen","state":"start"}
    Python->>Python: å¯åŠ¨5ç§’è¶…æ—¶æœºåˆ¶
    
    User->>Hardware: é‡Šæ”¾æŒ‰é”®ï¼ˆç¬é—´ï¼‰
    Hardware->>Python: {"type":"listen","state":"stop"}
    Python->>Python: âŒ å–æ¶ˆè¶…æ—¶æœºåˆ¶
    
    Note over Python: è¶…æ—¶æœºåˆ¶æ ¹æœ¬æ²¡æœºä¼šå·¥ä½œï¼
```

### **é—®é¢˜æ‰€åœ¨**ï¼š
1. **æŒ‰é”®æ¨¡å¼**ï¼š`"mode":"manual"` - æ‰‹åŠ¨æŒ‰é”®æ§åˆ¶
2. **å³æ—¶åœæ­¢**ï¼šæŒ‰é”®é‡Šæ”¾åç«‹å³å‘é€stopä¿¡å·
3. **è¶…æ—¶å¤±æ•ˆ**ï¼šè¶…æ—¶æœºåˆ¶åœ¨å¯åŠ¨çš„åŒä¸€æ—¶åˆ»å°±è¢«å–æ¶ˆ

## ğŸ›ï¸ **ç¡¬ä»¶ç«¯è¡Œä¸ºæ¨¡å¼åˆ†æ**

### **å½“å‰å®ç°ï¼ˆæŒ‰é”®ç›´æ§æ¨¡å¼ï¼‰**ï¼š
```cpp
// ç¡¬ä»¶ç«¯ä¼ªä»£ç 
void onButtonPress() {
    sendMessage({"type": "listen", "state": "start", "mode": "manual"});
}

void onButtonRelease() {
    sendMessage({"type": "listen", "state": "stop"});  // âŒ ç«‹å³åœæ­¢
}
```

### **æœŸæœ›çš„è¶…æ—¶æ¨¡å¼**ï¼š
```cpp
// æ”¹è¿›æ–¹æ¡ˆ
void onButtonPress() {
    sendMessage({"type": "listen", "state": "start", "mode": "timeout"});
    // ä¸åœ¨æŒ‰é”®é‡Šæ”¾æ—¶å‘é€stopï¼Œè®©æœåŠ¡ç«¯è¶…æ—¶æ§åˆ¶
}
```

## âœ… **è§£å†³æ–¹æ¡ˆ**

### **æ–¹æ¡ˆä¸€ï¼šä¿®æ”¹ç¡¬ä»¶ç«¯è¡Œä¸ºï¼ˆæ¨èï¼‰**

#### **ç¡¬ä»¶ç«¯ä»£ç ä¿®æ”¹**ï¼š
```cpp
// æ”¯æŒè¶…æ—¶æ¨¡å¼çš„æŒ‰é”®å¤„ç†
void onButtonPress() {
    if (timeoutMode) {
        // è¶…æ—¶æ¨¡å¼ï¼šåªå‘é€startï¼Œä¸å‘é€stop
        sendMessage({
            "type": "listen", 
            "state": "start", 
            "mode": "timeout",  // æ˜ç¡®æ ‡è¯†è¶…æ—¶æ¨¡å¼
            "timeout": 5.0
        });
    } else {
        // ä¼ ç»Ÿæ¨¡å¼ï¼šæŒ‰é”®æ§åˆ¶
        sendMessage({
            "type": "listen", 
            "state": "start", 
            "mode": "manual"
        });
    }
}

void onButtonRelease() {
    if (!timeoutMode) {
        // åªåœ¨éè¶…æ—¶æ¨¡å¼ä¸‹å‘é€stop
        sendMessage({"type": "listen", "state": "stop"});
    }
    // è¶…æ—¶æ¨¡å¼ä¸‹ä¸å‘é€stopï¼Œè®©æœåŠ¡ç«¯è‡ªåŠ¨è¶…æ—¶
}
```

### **æ–¹æ¡ˆäºŒï¼šæœåŠ¡ç«¯æ™ºèƒ½åˆ¤æ–­ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰**

ä¿®æ”¹PythonæœåŠ¡ç«¯ï¼Œåœ¨manualæ¨¡å¼ä¸‹å»¶è¿Ÿå¤„ç†stopæ¶ˆæ¯ï¼š

```python
# core/handle/textHandle.py
async def handleTextMessage(conn, message):
    # ... ç°æœ‰ä»£ç  ...
    elif msg_json["type"] == "listen":
        if msg_json["state"] == "start":
            # å¯åŠ¨è†å¬å’Œè¶…æ—¶
            conn.client_have_voice = True
            conn.client_voice_stop = False
            await _start_listening_timeout(conn)
            
        elif msg_json["state"] == "stop":
            # ğŸ¯ æ–°å¢ï¼šå¦‚æœæ˜¯manualæ¨¡å¼ï¼Œå»¶è¿Ÿå¤„ç†stop
            if getattr(conn, 'client_listen_mode', 'auto') == 'manual':
                # å»¶è¿Ÿ500mså¤„ç†stopï¼Œç»™è¶…æ—¶æœºåˆ¶ä¸€ä¸ªæœºä¼š
                await asyncio.sleep(0.5)
                
                # æ£€æŸ¥è¶…æ—¶ä»»åŠ¡æ˜¯å¦è¿˜åœ¨è¿è¡Œ
                timeout_task = getattr(conn, 'listening_timeout_task', None)
                if timeout_task and not timeout_task.done():
                    # è¶…æ—¶ä»»åŠ¡è¿˜åœ¨ï¼Œä¸å¤„ç†è¿™ä¸ªstop
                    conn.logger.bind(tag=TAG).info("ğŸ¯ æŒ‰é”®stopè¢«å»¶è¿Ÿï¼Œç­‰å¾…è¶…æ—¶æœºåˆ¶")
                    return
                    
            # æ­£å¸¸å¤„ç†stop
            await _cancel_listening_timeout(conn)
            # ... å…¶ä»–stopå¤„ç†é€»è¾‘ ...
```

### **æ–¹æ¡ˆä¸‰ï¼šæ–°å¢è¶…æ—¶ä¸“ç”¨æ¨¡å¼**

å¢åŠ ä¸€ä¸ªä¸“é—¨çš„è¶…æ—¶æ§åˆ¶æ¨¡å¼ï¼š

```python
# core/handle/textHandle.py  
elif msg_json["type"] == "listen":
    if "mode" in msg_json:
        conn.client_listen_mode = msg_json["mode"]
        
    if msg_json["state"] == "start":
        if conn.client_listen_mode == "timeout":
            # è¶…æ—¶æ¨¡å¼ï¼šåªå¯åŠ¨è¶…æ—¶ï¼Œä¸å“åº”æ‰‹åŠ¨stop
            await _start_listening_timeout(conn)
            conn.ignore_manual_stop = True  # æ ‡è®°å¿½ç•¥æ‰‹åŠ¨stop
        else:
            # å…¶ä»–æ¨¡å¼æ­£å¸¸å¤„ç†
            await _start_listening_timeout(conn)
            
    elif msg_json["state"] == "stop":
        if getattr(conn, 'ignore_manual_stop', False):
            # è¶…æ—¶æ¨¡å¼ä¸‹å¿½ç•¥æ‰‹åŠ¨stop
            conn.logger.bind(tag=TAG).info("ğŸ¯ è¶…æ—¶æ¨¡å¼ä¸‹å¿½ç•¥æ‰‹åŠ¨stopä¿¡å·")
            return
        else:
            # æ­£å¸¸å¤„ç†stop
            await _cancel_listening_timeout(conn)
```

## ğŸš€ **ç«‹å³å¯ç”¨çš„ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**

### **ä¿®æ”¹PythonæœåŠ¡ç«¯**ï¼ˆæ— éœ€ç¡¬ä»¶æ”¹åŠ¨ï¼‰ï¼š

```python
# åœ¨textHandle.pyä¸­æ·»åŠ å»¶è¿Ÿå¤„ç†
async def _handle_listen_stop_with_delay(conn, msg_json):
    """å»¶è¿Ÿå¤„ç†listen stopï¼Œç»™è¶…æ—¶æœºåˆ¶æœºä¼š"""
    if getattr(conn, 'client_listen_mode', 'auto') == 'manual':
        # manualæ¨¡å¼ä¸‹å»¶è¿Ÿ1ç§’å¤„ç†stop
        await asyncio.sleep(1.0)
        
        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨è¿™1ç§’å†…å¼€å§‹è¯´è¯
        if getattr(conn, 'client_have_voice', False) and not getattr(conn, 'client_voice_stop', True):
            # ç”¨æˆ·æ­£åœ¨è¯´è¯ï¼Œä¸å¤„ç†stop
            conn.logger.bind(tag=TAG).info("ğŸ¯ ç”¨æˆ·æ­£åœ¨è¯´è¯ï¼Œå¿½ç•¥æŒ‰é”®stop")
            return
            
    # æ­£å¸¸å¤„ç†stop
    await _cancel_listening_timeout(conn)
    # ... å…¶ä»–å¤„ç†é€»è¾‘ ...
```

## ğŸ§ª **æµ‹è¯•éªŒè¯æ–¹æ¡ˆ**

### **æµ‹è¯•åœºæ™¯1ï¼šå¿«é€ŸæŒ‰é”®**
```
æ“ä½œï¼šæŒ‰ä¸‹æŒ‰é”®ç«‹å³é‡Šæ”¾
æœŸæœ›ï¼šåº”è¯¥ç­‰å¾…5ç§’è¶…æ—¶ï¼Œè€Œä¸æ˜¯ç«‹å³åœæ­¢
å½“å‰ï¼šâŒ ç«‹å³åœæ­¢
ä¿®å¤åï¼šâœ… ç­‰å¾…5ç§’è¶…æ—¶
```

### **æµ‹è¯•åœºæ™¯2ï¼šé•¿æŒ‰æ¨¡å¼**  
```
æ“ä½œï¼šæŒ‰ä¸‹æŒ‰é”®ä¸é‡Šæ”¾ï¼Œ5ç§’åè‡ªåŠ¨è¶…æ—¶
æœŸæœ›ï¼š5ç§’åè‡ªåŠ¨åœæ­¢è†å¬
å½“å‰ï¼šâŒ æ°¸è¿œä¸ä¼šè¶…æ—¶ï¼ˆå› ä¸ºæ²¡é‡Šæ”¾æŒ‰é”®ï¼‰
ä¿®å¤åï¼šâœ… 5ç§’åè‡ªåŠ¨åœæ­¢
```

### **æµ‹è¯•åœºæ™¯3ï¼šè¯´è¯ä¸­é‡Šæ”¾**
```
æ“ä½œï¼šæŒ‰é”®å¼€å§‹è¯´è¯ï¼Œè¯´è¯è¿‡ç¨‹ä¸­é‡Šæ”¾æŒ‰é”®
æœŸæœ›ï¼šç»§ç»­ç­‰å¾…è¯­éŸ³ç»“æŸï¼Œä¸è¢«æŒ‰é”®é‡Šæ”¾æ‰“æ–­
å½“å‰ï¼šâŒ æŒ‰é”®é‡Šæ”¾ç«‹å³åœæ­¢
ä¿®å¤åï¼šâœ… ç»§ç»­ç­‰å¾…è¯­éŸ³ç»“æŸ
```

## ğŸ“Š **ä¸åŒæ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ | å®æ–½éš¾åº¦ | å…¼å®¹æ€§ | æ•ˆæœ | æ¨èåº¦ |
|------|----------|--------|------|---------|
| æ–¹æ¡ˆä¸€ï¼ˆç¡¬ä»¶æ”¹ï¼‰ | é«˜ | éœ€è¦ç¡¬ä»¶é…åˆ | æœ€ä½³ | â­â­â­â­â­ |
| æ–¹æ¡ˆäºŒï¼ˆå»¶è¿Ÿå¤„ç†ï¼‰ | ä½ | å®Œå…¨å…¼å®¹ | è‰¯å¥½ | â­â­â­â­ |
| æ–¹æ¡ˆä¸‰ï¼ˆæ–°å¢æ¨¡å¼ï¼‰ | ä¸­ | éœ€è¦ç¡¬ä»¶æ”¯æŒ | å¾ˆå¥½ | â­â­â­â­ |

## ğŸ¯ **æ ¸å¿ƒé—®é¢˜æ€»ç»“**

**è†å¬è¶…æ—¶æœºåˆ¶æœ¬èº«æ˜¯æ­£å¸¸çš„ï¼Œé—®é¢˜å‡ºåœ¨ç¡¬ä»¶ç«¯çš„æŒ‰é”®è¡Œä¸ºä¸è¶…æ—¶æœºåˆ¶çš„è®¾è®¡ç†å¿µå†²çªï¼**

- **ç¡¬ä»¶é€»è¾‘**ï¼šæŒ‰é”®é‡Šæ”¾ = ç«‹å³åœæ­¢è†å¬
- **è¶…æ—¶é€»è¾‘**ï¼šå¼€å§‹è†å¬åï¼Œç­‰å¾…5ç§’æ— è¯­éŸ³æ‰åœæ­¢
- **å†²çªç‚¹**ï¼šæŒ‰é”®é‡Šæ”¾çš„ç¬é—´å°±å–æ¶ˆäº†è¶…æ—¶æœºåˆ¶

**è§£å†³æ€è·¯**ï¼šè®©æŒ‰é”®åªè´Ÿè´£"å¼€å§‹è†å¬"ï¼Œåœæ­¢è†å¬äº¤ç»™è¶…æ—¶æœºåˆ¶æˆ–VADæ£€æµ‹ã€‚

---

**ğŸ”§ éœ€è¦ä½ ç¡®è®¤é‡‡ç”¨å“ªç§æ–¹æ¡ˆï¼Œæˆ‘å¯ä»¥ç«‹å³å®æ–½ï¼**

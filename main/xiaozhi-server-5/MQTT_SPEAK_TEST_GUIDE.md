# 🔧 MQTT SPEAK测试工具使用指南

## 📊 **工具概述**

为了验证硬件MQTT连接和SPEAK命令处理，我们提供了两个测试工具：

### **1. 详细测试工具** - `test_speak_ack.py`
- ✅ 完整的测试流程和详细报告
- ✅ 监听ACK确认和事件消息
- ✅ 响应时间测量
- ✅ 详细的调试信息

### **2. 快速测试工具** - `quick_speak_test.py`  
- ⚡ 简化的快速测试
- ⚡ 专注于核心功能验证
- ⚡ 适合快速诊断

## 🚀 **使用方法**

### **方法1: 详细测试（推荐）**

```bash
# 基础测试
python test_speak_ack.py 7c:2c:67:8d:89:78

# 自定义测试内容
python test_speak_ack.py 7c:2c:67:8d:89:78 "今天吃药了吗？"

# 自定义超时时间
python test_speak_ack.py 7c:2c:67:8d:89:78 "健康提醒测试" 60
```

### **方法2: 快速测试**

```bash
# 快速测试
python quick_speak_test.py 7c:2c:67:8d:89:78

# 其他设备
python quick_speak_test.py f0:9e:9e:04:8a:44
```

## 📈 **测试流程说明**

### **完整测试流程**
```
1. 连接MQTT服务器 (47.97.185.142:1883)
2. 订阅ACK和事件主题
3. 发送SPEAK命令到硬件
4. 等待硬件ACK确认
5. 监听播放完成事件
6. 生成详细测试报告
```

### **MQTT主题说明**
- **命令主题**: `device/{设备MAC}/cmd` - 发送SPEAK命令
- **ACK主题**: `device/{设备MAC}/ack` - 接收确认响应
- **事件主题**: `device/{设备MAC}/event` - 接收播放事件

## 🎯 **预期结果**

### **✅ 硬件正常时**
```bash
[14:30:15.123] ✅ MQTT连接成功!
[14:30:15.124] ✅ 主题订阅成功!
[14:30:17.125] ✅ SPEAK命令发送成功!
[14:30:17.200] ✅ 收到ACK确认! 响应时间: 75.0ms
[14:30:22.300] ✅ 收到事件: EVT_SPEAK_DONE

🎉 测试成功! 硬件MQTT通信正常
```

### **❌ 硬件异常时**
```bash
[14:30:15.123] ✅ MQTT连接成功!
[14:30:15.124] ✅ 主题订阅成功!
[14:30:17.125] ✅ SPEAK命令发送成功!
[14:30:47.125] ⏳ 还在等待... 剩余10秒

❌ 测试失败! 未收到ACK确认
🔧 硬件可能无法连接MQTT或无法处理命令
```

## 🔍 **问题诊断**

### **情况1: MQTT连接失败**
```bash
❌ MQTT连接失败: 5
```
**解决方案**: 检查网络连接和MQTT服务器状态

### **情况2: 命令发送成功但无ACK**
```bash
✅ SPEAK命令发送成功!
❌ 测试失败! 未收到ACK确认
```
**问题**: 硬件无法连接MQTT或无法处理命令
**检查项目**:
1. 硬件MQTT配置是否正确
2. 硬件网络连接是否正常
3. 硬件是否正确订阅命令主题

### **情况3: 收到ACK但无播放事件**
```bash
✅ 收到ACK确认!
⏳ 等待5秒查看是否有播放完成事件...
```
**问题**: 硬件接收命令正常，但播放流程有问题
**检查项目**:
1. WebSocket连接是否正常
2. 音频播放功能是否正常

## 🛠️ **MQTT消息格式**

### **发送的SPEAK命令**
```json
{
  "cmd": "SPEAK",
  "text": "测试语音播放",
  "track_id": "TEST1724567890abc123",
  "audio_url": "ws://47.98.51.180:8000/xiaozhi/v1/"
}
```

### **期望的ACK响应**
```json
{
  "evt": "CMD_RECEIVED",
  "track_id": "TEST1724567890abc123",
  "timestamp": "14:30:17",
  "device_id": "7c:2c:67:8d:89:78"
}
```

### **期望的播放完成事件**
```json
{
  "evt": "EVT_SPEAK_DONE", 
  "track_id": "TEST1724567890abc123",
  "timestamp": "14:30:22",
  "device_id": "7c:2c:67:8d:89:78"
}
```

## 🚨 **故障排除**

### **步骤1: 检查MQTT服务器连通性**
```bash
# 在硬件或服务器上测试
telnet 47.97.185.142 1883
```

### **步骤2: 检查MQTT认证**
```bash
# 使用mosquitto客户端测试
mosquitto_pub -h 47.97.185.142 -p 1883 -u admin -P Jyxd@2025 -t "test" -m "hello"
```

### **步骤3: 监控MQTT流量**
```bash
# 监控所有MQTT消息
python mqtt_debug.py 7c:2c:67:8d:89:78
```

### **步骤4: 检查硬件日志**
查看硬件端的MQTT连接和消息处理日志

## 📊 **测试报告解读**

### **完整成功示例**
```
📊 MQTT SPEAK和ACK测试报告
================================================================================
📱 测试设备: 7c:2c:67:8d:89:78
🎯 Track ID: TEST1724567890abc123
📡 MQTT服务器: 47.97.185.142:1883
📅 测试时间: 2025-08-25 14:30:15

🔍 测试结果:
  ✅ 1️⃣ MQTT连接: 通过
  ✅ 2️⃣ 主题订阅: 通过  
  ✅ 3️⃣ SPEAK命令发送: 通过
  ✅ 4️⃣ ACK确认接收: 通过
  📋 ACK数据: {'evt': 'CMD_RECEIVED', 'track_id': 'TEST...', 'timestamp': '14:30:17'}
  ⏱️ 响应时间: 75.0ms

🎉 测试成功! 硬件MQTT连接正常，能够接收命令并发送ACK确认
💡 说明硬件与MQTT服务器通信正常
```

## 🎯 **总结**

这些测试工具可以帮助您：

1. **验证MQTT连接**: 确认硬件能否连接到MQTT服务器
2. **测试命令接收**: 验证硬件能否接收SPEAK命令
3. **确认ACK机制**: 验证硬件的确认响应功能
4. **诊断通信问题**: 快速定位MQTT通信故障点

**使用建议**: 先运行快速测试快速判断，再运行详细测试获取完整信息。

---
*使用这些工具可以精确定位硬件MQTT连接问题，为解决语音播放故障提供明确的诊断依据。*

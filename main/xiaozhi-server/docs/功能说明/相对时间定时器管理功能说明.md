# 相对时间定时器管理功能说明

## 🎯 功能概述

在原有的相对时间定时器功能基础上，新增了完整的管理功能，支持**查询**、**删除**、**修改**相对时间定时器，并通过**多轮对话**确保操作的准确性。

## 🌟 核心特性

### ✅ **统一管理**
- 管理两套定时器系统：`schedule_relative_timer` 和 `save_user_strategy`临时处理
- 统一的定时器信息注册表
- 支持设备级别的定时器隔离

### ✅ **智能多轮对话**
- 自动询问确认具体操作
- 支持时间和内容关键词匹配
- LLM生成自然的对话回复

### ✅ **完整的CRUD操作**
- **Create**: 创建相对时间定时器 ✅ (已有功能)
- **Read**: 查询当前定时器列表 🆕
- **Update**: 修改定时器时间 🆕
- **Delete**: 删除指定定时器 🆕

## 📋 功能详情

### 1. 查询定时器 (`list_relative_timers`)

**触发词汇**：
- "有哪些闹钟"
- "查看定时提醒"
- "现在设置了什么提醒"
- "查看我的定时器"

**功能**：
- 列出当前设备的所有活跃相对时间定时器
- 显示剩余时间和提醒内容
- 按时间顺序排序

**示例对话**：
```
用户: "有哪些闹钟？"
小智: "当前的相对时间提醒：
      1. 12:31 - 叫我开会 (还有29分钟)
      2. 13:02 - 提醒我休息 (还有1小时)"
```

### 2. 删除定时器 (`cancel_relative_timer`)

**触发词汇**：
- "取消闹钟"
- "删除提醒"
- "取消定时器"
- "取消12点的提醒"

**多轮对话流程**：

#### 场景A：用户只说"取消闹钟"
```
用户: "取消闹钟"
小智: "当前的相对时间提醒：
      1. 12:31 - 叫我开会 (还有29分钟)
      2. 13:02 - 提醒我休息 (还有1小时)
      请告诉我要取消哪个提醒，可以说时间或内容。"

用户: "取消开会的"
小智: "已成功取消12:31的叫我开会提醒。"
```

#### 场景B：用户直接指定时间
```
用户: "取消12点的提醒"
小智: "已成功取消12:31的叫我开会提醒。"
```

#### 场景C：用户指定内容关键词
```
用户: "删除吃饭提醒"  
小智: "已成功取消XX:XX的叫我吃饭提醒。"
```

### 3. 修改定时器 (`modify_relative_timer`)

**触发词汇**：
- "修改闹钟"
- "更改提醒时间"
- "修改定时器"
- "修改12点的提醒"

**多轮对话流程**：

#### 场景A：完整的多轮确认过程
```
用户: "修改闹钟"
小智: "当前的相对时间提醒：
      1. 12:31 - 叫我开会 (还有29分钟)
      2. 13:02 - 提醒我休息 (还有1小时)
      请告诉我要修改哪个提醒。"

用户: "修改开会的"
小智: "找到了12:31的叫我开会提醒。请告诉我希望改到什么时间，比如'30分钟后'或'1小时后'。"

用户: "改成45分钟后"
小智: "已成功将叫我开会的提醒时间修改为45分钟后（预计12:47）。"
```

#### 场景B：用户直接指定要修改的定时器
```
用户: "修改12点的提醒"
小智: "找到了12:31的叫我开会提醒。请告诉我希望改到什么时间，比如'30分钟后'或'1小时后'。"
```

## 🔧 技术实现

### 架构设计

```
定时器管理系统
├── manage_relative_timers.py (新增)
│   ├── list_relative_timers()     # 查询功能
│   ├── cancel_relative_timer()    # 删除功能
│   ├── modify_relative_timer()    # 修改功能
│   └── timer_registry{}           # 统一注册表
│
├── schedule_relative_timer.py (增强)
│   └── 集成定时器信息注册
│
└── save_user_strategy.py (增强)
    └── 临时处理集成定时器信息注册
```

### 数据结构

**定时器注册表** (`timer_registry`):
```python
{
    "timer_id": {
        "device_id": "f0:9e:9e:04:8a:44",
        "content": "吃饭",
        "action_type": "叫我",
        "target_time": datetime(2025, 9, 1, 12, 31),
        "duration_description": "30分钟",
        "timer_type": "relative",  # relative / temp_relative
        "created_time": datetime.now(),
        "status": "active"  # active / cancelled / modified
    }
}
```

### LLM意图识别

新增意图识别规则：
- **查询**: `list_relative_timers`
- **删除**: `cancel_relative_timer` + `confirm_action`
- **修改**: `modify_relative_timer` + `confirm_action`

支持的`confirm_action`类型：
- `"list"`: 列出定时器供用户选择
- `"cancel"`: 确认删除指定定时器
- `"select"`: 选择要修改的定时器
- `"modify"`: 确认修改操作

## 🎮 使用示例

### 完整的使用流程

```
# 1. 创建定时器
用户: "30分钟后叫我吃饭"
小智: "好的，已设置30分钟后的吃饭提醒，预计12:31提醒您。"

# 2. 查询定时器
用户: "有哪些闹钟？"
小智: "当前的相对时间提醒：
      1. 12:31 - 叫我吃饭 (还有29分钟)"

# 3. 修改定时器
用户: "修改闹钟"
小智: "当前的相对时间提醒：
      1. 12:31 - 叫我吃饭 (还有29分钟)
      请告诉我要修改哪个提醒。"
用户: "修改吃饭的"
小智: "找到了12:31的叫我吃饭提醒。请告诉我希望改到什么时间。"
用户: "改成1小时后"
小智: "已成功将叫我吃饭的提醒时间修改为1小时后（预计13:01）。"

# 4. 取消定时器
用户: "取消吃饭提醒"
小智: "已成功取消13:01的叫我吃饭提醒。"
```

## 🚀 部署说明

### 新增文件
- `plugins_func/functions/manage_relative_timers.py` - 主要功能实现

### 修改文件
- `core/providers/tools/server_plugins/plugin_executor.py` - 添加新函数到补充列表
- `core/providers/intent/intent_llm/intent_llm.py` - 新增意图识别规则和示例
- `plugins_func/functions/schedule_relative_timer.py` - 集成定时器信息注册
- `plugins_func/functions/save_user_strategy.py` - 集成临时定时器信息注册

### 部署步骤

1. **文件部署**: 确保所有新增和修改的文件已部署
2. **重启服务**: 重启Python服务以加载新功能
3. **功能测试**: 按照使用示例进行功能验证

## ⚠️ 注意事项

### 兼容性
- ✅ 完全兼容现有的相对时间定时器功能
- ✅ 支持两套定时器系统的统一管理
- ✅ 不影响绝对时间定时器（Java后端管理）

### 限制
- 只管理相对时间定时器，不涉及Java后端的绝对时间定时器
- 定时器信息存储在内存中，服务重启后会丢失历史记录
- 多轮对话状态简化处理，复杂场景可能需要用户重新确认

### 扩展性
- 支持添加更多定时器类型
- 可扩展更复杂的多轮对话逻辑
- 可添加定时器持久化存储

## 🎉 总结

新的定时器管理功能为用户提供了完整的相对时间定时器管理体验：

✅ **用户友好**: 自然语言交互，多轮对话确认  
✅ **功能完整**: 查询、删除、修改一应俱全  
✅ **智能化**: LLM驱动的意图识别和对话生成  
✅ **稳定可靠**: 统一管理，向下兼容  

用户现在可以通过自然对话轻松管理所有的相对时间定时器，大大提升了使用体验！

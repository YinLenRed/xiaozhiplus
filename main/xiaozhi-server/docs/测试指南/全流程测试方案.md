# 🔧 小智系统全流程测试方案

## 📋 系统架构概述

```
触发源(Java API) → Python服务 → MQTT服务器 → 硬件设备 → WebSocket服务器
     ↓              ↓            ↓           ↓              ↓
  主动问候触发    LLM生成智能内容   推送命令      设备唤醒        音频播放
```

## 🎯 测试目标

### 核心功能验证
- ✅ Java API触发主动问候
- ✅ Python LLM内容生成
- ✅ MQTT命令传输和ACK确认  
- ✅ WebSocket音频流传输
- ✅ 硬件设备完整响应流程

### 性能指标要求
- 🚀 端到端延迟 < 3秒
- 📡 MQTT ACK响应时间 < 100ms
- 🎵 音频传输完整性 > 99%
- 🔄 系统可用性 > 99.9%

---

## 🏗️ 测试环境准备

### 服务器环境
```yaml
MQTT服务器: 47.97.185.142:1883
WebSocket服务器: ws://47.98.51.180:8000/xiaozhi/v1/
Java API服务: http://q83b6ed9.natappfree.cc
Python服务: http://47.98.51.180:8003
```

### 硬件设备配置
```yaml
设备ID示例: 7c:2c:67:8d:89:78
MQTT订阅主题: device/{device-id}/command
MQTT发布主题:
  - device/{device-id}/ack (ACK确认)
  - device/{device-id}/event (播放完成)
```

---

## 🧪 测试层级分解

## 1️⃣ 单元测试 (Unit Tests)

### Java API层测试
- **触发接口测试**: `/api/trigger-greeting`
- **设备管理接口**: `/api/device/*`
- **配置管理接口**: `/config/server-base`

### Python服务测试
- **LLM内容生成**: `plugins_func/functions/save_user_strategy.py`
- **TTS音频生成**: `core/tts/*`
- **MQTT消息发布**: `core/mqtt/mqtt_client.py`
- **WebSocket音频流**: `core/websocket_server.py`

### 硬件设备测试
- **MQTT客户端连接**: 连接稳定性测试
- **命令接收处理**: SPEAK命令解析测试
- **ACK确认机制**: 响应时间测试
- **WebSocket音频接收**: 音频播放测试

---

## 2️⃣ 集成测试 (Integration Tests)

### Java ↔ Python集成
- **WebSocket通信**: 服务间消息传递
- **配置同步**: 配置更新传播测试
- **状态管理**: 设备状态同步测试

### Python ↔ MQTT集成
- **消息发布**: SPEAK命令发送
- **消息订阅**: ACK/Event消息接收
- **错误处理**: 连接异常恢复测试

### Python ↔ WebSocket集成
- **音频流传输**: TTS音频推送
- **连接管理**: 设备连接状态管理
- **并发处理**: 多设备同时音频传输

### MQTT ↔ 硬件集成
- **命令传输**: 端到端命令传递
- **状态上报**: 设备状态实时更新
- **网络异常**: 断网重连测试

---

## 3️⃣ 端到端测试 (E2E Tests)

### 完整流程测试
```yaml
测试场景: 主动问候完整流程
步骤:
  1. Java API触发主动问候
  2. Python生成LLM内容
  3. 发布SPEAK命令到MQTT
  4. 硬件收到命令发送ACK
  5. Python生成TTS音频
  6. WebSocket传输音频到设备
  7. 设备播放完成上报事件
```

### 性能压力测试
- **并发用户**: 100个设备同时触发
- **长时间运行**: 24小时稳定性测试
- **资源监控**: CPU/内存/网络使用率

---

## 🛠️ 测试工具和脚本

### 自动化测试脚本
- `test_full_flow.py` - 全流程自动化测试
- `test_mqtt_stress.py` - MQTT压力测试
- `test_websocket_audio.py` - 音频传输测试
- `test_device_simulator.py` - 硬件设备模拟器

### 监控和调试工具
- `monitor_system.py` - 系统状态实时监控
- `debug_mqtt.py` - MQTT消息调试工具
- `analyze_logs.py` - 日志分析工具

---

## 📊 测试报告模板

### 测试结果记录
```yaml
测试ID: TEST_001
测试名称: 主动问候全流程测试
测试时间: 2025-01-27 10:30:00
测试环境: 生产环境
测试结果: PASS/FAIL
执行时间: 2.3秒
详细日志: logs/test_001.log
```

### 问题追踪
```yaml
问题ID: BUG_001
问题描述: WebSocket音频传输中断
严重程度: HIGH/MEDIUM/LOW
负责组件: Python WebSocket服务
修复状态: OPEN/IN_PROGRESS/RESOLVED
```

---

## 🚀 快速开始

### 环境搭建
```bash
# 1. 启动Java API服务
cd xiaozhi-esp32-server-main/main/manager-api
mvn spring-boot:run

# 2. 启动Python服务
cd xiaozhi-esp32-server-main/main/xiaozhi-server
python main.py

# 3. 验证MQTT连接
python mqtt_test.py

# 4. 运行全流程测试
python test_full_flow.py
```

### 第一次测试
```bash
# 运行基础连通性测试
python quick_health_check.py

# 如果基础测试通过，运行完整流程测试
python test_complete_flow.py --device-id 7c:2c:67:8d:89:78
```

---

## ⚠️ 常见问题解决

### MQTT连接问题
- 检查防火墙端口1883是否开放
- 验证用户名密码: admin/Jyxd@2025
- 确认设备ID格式正确

### WebSocket音频问题
- 检查音频编码格式兼容性
- 验证网络带宽是否足够
- 确认设备WebSocket客户端实现

### 硬件响应问题
- 验证MQTT主题订阅正确
- 检查ACK消息格式
- 确认播放完成事件上报

---

## 📈 测试进度跟踪

| 测试类型 | 完成度 | 负责人 | 截止日期 | 状态 |
|---------|--------|--------|----------|------|
| Java API测试 | 0% | Java团队 | 2025-01-30 | 待开始 |
| Python服务测试 | 0% | Python团队 | 2025-01-30 | 待开始 |  
| 硬件设备测试 | 0% | 硬件团队 | 2025-02-02 | 待开始 |
| 集成测试 | 0% | 测试团队 | 2025-02-05 | 待开始 |
| E2E测试 | 0% | 全体 | 2025-02-07 | 待开始 |

---

✅ **下一步**: 创建具体的测试脚本和工具

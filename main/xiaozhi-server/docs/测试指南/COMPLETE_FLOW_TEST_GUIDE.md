# 🎯 完整硬件音频播放测试指南

## 📋 **测试脚本说明**

`complete_hardware_simulation.py` 是一个完整的硬件音频播放测试工具，测试从Python服务到硬件真实播放的完整流程。

### ✨ **功能特点**

- 🔄 **完整流程测试**: API → LLM → TTS → MQTT → WebSocket → 硬件播放
- 🏥 **健康提醒内容**: 内置多种用药和用餐提醒话术
- 📊 **实时监控**: MQTT监控硬件ACK和播放完成事件
- ⏱️ **性能分析**: 响应时间和播放时长统计
- 🎯 **状态跟踪**: 详细的流程步骤状态显示

---

## 🚀 **快速使用**

### **基本用法**
```bash
# 使用默认设备和随机健康提醒内容
python complete_hardware_simulation.py

# 指定设备ID
python complete_hardware_simulation.py f0:9e:9e:04:8a:44

# 使用自定义健康提醒内容
python complete_hardware_simulation.py f0:9e:9e:04:8a:44 --text "现在是下午2点，该吃午餐了。饭后记得按时服药哦！"

# 设置更长的超时时间（秒）
python complete_hardware_simulation.py f0:9e:9e:04:8a:44 --timeout 600
```

### **参数说明**
- `device_id`: 硬件设备ID (可选，默认: f0:9e:9e:04:8a:44)
- `--text, -t`: 自定义测试文本
- `--timeout`: 超时时间(秒，默认300秒=5分钟)

---

## 📝 **内置健康提醒内容**

脚本内置了5种健康提醒话术：

1. **用餐+用药提醒**: "现在是吃饭时间了，记得按时用餐保持身体健康。用餐后请不要忘记按时服药哦！"

2. **午餐提醒**: "今天该吃午饭了，营养均衡很重要。吃完饭半小时后记得服用您的常用药物。"

3. **温馨提醒**: "亲爱的，现在是用餐时间，请记得好好吃饭。餐后请按医嘱及时服用药物，保持身体健康。"

4. **晚餐提醒**: "该吃晚饭啦！记得荤素搭配营养均衡。用餐后请按时服药，这对您的健康很重要。"

5. **单纯用药提醒**: "现在是用药时间提醒：请记得按时服药，如果刚用完餐请间隔适当时间再服用。"

---

## 🔄 **完整测试流程**

### **步骤1: API调用**
- 调用 `/xiaozhi/greeting/send` 接口
- 发送健康提醒内容和设备ID
- 获取 track_id 用于流程跟踪

### **步骤2: 服务器端处理**
- LLM智能扩展健康提醒内容
- TTS生成高质量音频文件
- MQTT发送SPEAK命令给硬件

### **步骤3: 硬件响应**
- 硬件接收MQTT命令
- 发送ACK确认给服务器
- 连接WebSocket接收音频数据

### **步骤4: 音频播放**
- WebSocket推送音频流给硬件
- 硬件解码并播放音频
- 播放完成后发送EVT_SPEAK_DONE事件

---

## 📊 **输出示例**

```
🎯 完整硬件音频播放测试
📋 测试内容: 健康提醒音频播放
🔄 测试流程: API → LLM → TTS → MQTT → WebSocket → 硬件播放
================================================================================

[17:15:23.456] ℹ️ 🔧 步骤1: 设置MQTT监控...
[17:15:23.789] ✅ MQTT监控连接成功
[17:15:23.790] ℹ️ 📡 已订阅主题: device/f0:9e:9e:04:8a:44/ack, device/f0:9e:9e:04:8a:44/event

[17:15:25.123] ℹ️ 🔧 步骤2: 发送健康提醒API...
[17:15:25.124] ℹ️ 📝 健康提醒内容: 现在是吃饭时间了，记得按时用餐保持身体健康...
[17:15:25.456] ✅ API调用成功! Track ID: WX202508251715252a4b3c

[17:15:25.789] ℹ️ 🔧 步骤3: 等待硬件音频播放完成...
[17:15:26.123] ℹ️ 📥 收到ACK: {'evt': 'CMD_RECEIVED', 'track_id': 'WX202508251715252a4b3c', 'timestamp': '17:15:26'}
[17:15:26.124] ✅ 硬件ACK确认成功! 响应时间: 335.2ms
[17:15:26.125] ℹ️ 🌐 硬件正在连接WebSocket接收音频...

[17:17:45.678] ℹ️ 📥 收到EVENT: {'evt': 'EVT_SPEAK_DONE', 'track_id': 'WX202508251715252a4b3c', 'timestamp': '17:17:45'}
[17:17:45.679] ✅ 音频播放完成! 总用时: 140.2秒

================================================================================
🎯 完整硬件音频播放测试结果
================================================================================
📱 测试设备: f0:9e:9e:04:8a:44
🎯 Track ID: WX202508251715252a4b3c
📅 测试时间: 2025-08-25 17:15:25

✅ 🚀 API调用        : 成功
✅ 📡 MQTT监控       : 成功
✅ 📥 硬件ACK确认     : 成功
✅ 🎵 音频播放完成    : 成功
--------------------------------------------------------------------------------
⏱️ API → ACK: 335.2ms
⏱️ 总流程时间: 140.2秒

⚡ 性能评级: 良好

📈 总体结果: 4/4 步骤成功
🎉 恭喜！完整的硬件音频播放测试成功！
✅ 硬件能够正常接收并播放健康提醒音频
================================================================================
```

---

## 🔧 **故障排查**

### **常见问题**

1. **硬件无ACK响应**
   - 检查设备是否在线
   - 验证MQTT连接配置
   - 确认设备ID正确

2. **API调用失败**
   - 检查服务器是否运行(8003端口)
   - 验证网络连接
   - 确认API接口地址

3. **播放超时**
   - 增加timeout参数值
   - 检查TTS服务状态
   - 验证WebSocket连接

### **调试命令**

```bash
# 检查设备是否在线
mosquitto_pub -h 47.97.185.142 -p 1883 -u admin -P Jyxd@2025 \
  -t "device/f0:9e:9e:04:8a:44/cmd" \
  -m '{"cmd":"PING","timestamp":"'$(date +%H:%M:%S)'"}'

# 监控设备响应
mosquitto_sub -h 47.97.185.142 -p 1883 -u admin -P Jyxd@2025 \
  -t "device/f0:9e:9e:04:8a:44/+" -v

# 检查服务器状态
curl -s "http://172.20.12.204:8003/xiaozhi/greeting/status?device_id=f0:9e:9e:04:8a:44"
```

---

## ⚡ **快速测试命令**

```bash
# 立即运行完整测试
python complete_hardware_simulation.py f0:9e:9e:04:8a:44

# 测试自定义健康提醒
python complete_hardware_simulation.py f0:9e:9e:04:8a:44 \
  --text "今天该吃药了，记得饭后半小时服用，多喝水有助于药物吸收。"

# 长时间测试（10分钟超时）
python complete_hardware_simulation.py f0:9e:9e:04:8a:44 --timeout 600
```

---

🎯 **这个脚本会测试真正的音频生成和硬件播放流程，确保硬件能够正常播放健康提醒音频！**
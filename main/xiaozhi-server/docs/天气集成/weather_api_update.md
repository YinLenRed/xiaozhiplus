# å¤©æ°”APIé›†æˆæ›´æ–°è¯´æ˜

## ğŸ“… æ›´æ–°ä¿¡æ¯

**æ›´æ–°æ—¥æœŸï¼š** 2025å¹´8æœˆ14æ—¥  
**æ›´æ–°åŸå› ï¼š** é›†æˆJavaåç«¯å¤©æ°”API  
**å½±å“èŒƒå›´ï¼š** ä¸»åŠ¨é—®å€™åŠŸèƒ½çš„å¤©æ°”ç±»åˆ«  

## ğŸ¯ Javaå·¥ç¨‹å¸ˆå»ºè®®æ€»ç»“

åŸºäºJavaåç«¯å·¥ç¨‹å¸ˆçš„å»ºè®®ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆä»¥ä¸‹é›†æˆï¼š

### âœ… Javaå·¥ç¨‹å¸ˆæåˆ°çš„è¦ç‚¹ï¼š
1. **å¤©æ°”æŸ¥è¯¢å°è£…æˆTool** - âœ… å·²å®ç°
2. **åªéœ€æä¾›device_id** - âœ… å·²æ”¯æŒ
3. **é€šè¿‡è®¾å¤‡ç»‘å®šåŸå¸‚æŸ¥è¯¢** - âœ… ä¾èµ–Javaåç«¯å®ç°
4. **è¿”å›JSONå¤©æ°”æ•°æ®** - âœ… å·²é›†æˆ
5. **AIæ¨¡å‹è°ƒç”¨å¤–éƒ¨å·¥å…·** - âœ… å·²æ”¯æŒFunction Calling

## ğŸ”§ Pythonç«¯å·²å®Œæˆçš„ä¿®æ”¹

### 1. æ–°å¢æ–‡ä»¶

#### `core/tools/weather_tool.py` (æ–°å¢)
- **åŠŸèƒ½ï¼š** å¤©æ°”æŸ¥è¯¢å·¥å…·ç±»
- **ç‰¹æ€§ï¼š**
  - è°ƒç”¨Javaåç«¯ `/api/weather/device/{device_id}` æ¥å£
  - æ ¼å¼åŒ–å¤©æ°”æ•°æ®ä¸ºé—®å€™è¯­è¨€
  - æ”¯æŒLLM Function Calling
  - æä¾›APIä¸å¯ç”¨æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

```python
# ä¸»è¦æ¥å£
async def get_weather_by_device(device_id: str) -> Dict[str, Any]
def format_weather_for_greeting(weather_data: Dict[str, Any]) -> str
```

### 2. å‡çº§ç°æœ‰æ–‡ä»¶

#### `core/mqtt/proactive_greeting_service.py` (ä¿®æ”¹)
**æ–°å¢åŠŸèƒ½ï¼š**
- é›†æˆå¤©æ°”å·¥å…·
- å¤©æ°”ç±»é—®å€™è‡ªåŠ¨è·å–å®æ—¶å¤©æ°”
- æ”¯æŒFunction Callingæœºåˆ¶
- å¢å¼ºçš„å†…å®¹ç”Ÿæˆé€»è¾‘

**å…³é”®æ”¹åŠ¨ï¼š**
```python
# å¤©æ°”ç±»åˆ«ç‰¹æ®Šå¤„ç†
if category == "weather" and device_id:
    weather_info = await self.weather_tool.get_weather_by_device(device_id)
    weather_text = self.weather_tool.format_weather_for_greeting(weather_info)
    enhanced_content = f"{initial_content}ã€‚{weather_text}"
```

### 3. æ–°å¢æ–‡æ¡£

#### `docs/java_weather_integration.md` (æ–°å¢)
- **å†…å®¹ï¼š** å®Œæ•´çš„Javaåç«¯é›†æˆæŒ‡å—
- **åŒ…å«ï¼š** APIè§„èŒƒã€ä»£ç ç¤ºä¾‹ã€æµ‹è¯•æ–¹æ¡ˆ

## ğŸŒ å¯¹Javaåç«¯çš„è¦æ±‚

### å¿…éœ€æä¾›çš„APIæ¥å£

**æ¥å£ï¼š** `GET /api/weather/device/{device_id}`

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```bash
curl -H "Authorization: Bearer your-api-secret" \
     "http://java-server:8080/api/weather/device/ESP32_001"
```

**å“åº”æ ¼å¼ï¼š**
```json
{
  "city": "å¹¿å·",
  "temperature": "28",
  "weather": "æ™´",
  "high": "32",
  "low": "24",
  "wind": "ä¸œå—é£2çº§",
  "humidity": "65%",
  "suggestion": "å¤©æ°”æ™´æœ—ï¼Œé€‚åˆå¤–å‡ºæ´»åŠ¨",
  "updateTime": "2024-12-01 14:00:00"
}
```

### Javaåç«¯éœ€è¦å®ç°çš„é€»è¾‘ï¼š
1. âœ… æ ¹æ®device_idæŸ¥æ‰¾ç»‘å®šçš„åŸå¸‚
2. âœ… è°ƒç”¨ç¬¬ä¸‰æ–¹å¤©æ°”APIè·å–æ•°æ®
3. âœ… æ ¼å¼åŒ–è¿”å›æ ‡å‡†JSONæ ¼å¼
4. âœ… å¤„ç†è®¾å¤‡æœªç»‘å®šåŸå¸‚çš„æƒ…å†µ

## ğŸš€ ä½¿ç”¨æ•ˆæœæ¼”ç¤º

### åŸæ¥çš„æ–¹å¼ï¼š
```json
è¯·æ±‚: {
  "device_id": "ESP32_001",
  "initial_content": "ä»Šå¤©å¤©æ°”ä¸é”™",
  "category": "weather"
}

ç”Ÿæˆ: "æå”ï¼Œä»Šå¤©å¤©æ°”ä¸é”™ï¼Œè®°å¾—é€‚å½“æ·»å‡è¡£ç‰©ã€‚"
```

### ç°åœ¨çš„æ–¹å¼ï¼š
```json
è¯·æ±‚: {
  "device_id": "ESP32_001", 
  "initial_content": "ä»Šå¤©å¤©æ°”ä¸é”™",
  "category": "weather"
}

è‡ªåŠ¨è·å–: å¹¿å·å®æ—¶å¤©æ°”æ•°æ®
å¢å¼ºå†…å®¹: "ä»Šå¤©å¤©æ°”ä¸é”™ã€‚å¹¿å·ä»Šå¤©æ™´ï¼Œå½“å‰æ¸©åº¦28â„ƒï¼Œæœ€é«˜32â„ƒï¼Œæœ€ä½24â„ƒ"
AIç”Ÿæˆ: "æå”ï¼Œå¹¿å·ä»Šå¤©å¤©æ°”æ™´æœ—ï¼Œ28â„ƒå¾ˆèˆ’é€‚ï¼Œæœ€é«˜32â„ƒï¼Œå¾ˆé€‚åˆå‡ºé—¨æ•£æ­¥å‘¢ï¼"
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### å·²å®ç°çš„ä¼˜åŒ–ï¼š
- **å¼‚æ­¥è°ƒç”¨ï¼š** ä¸é˜»å¡ä¸»æµç¨‹
- **è¶…æ—¶æ§åˆ¶ï¼š** 10ç§’è¶…æ—¶é¿å…é•¿æ—¶é—´ç­‰å¾…
- **é”™è¯¯é™çº§ï¼š** APIå¤±è´¥æ—¶ä½¿ç”¨åŸå§‹å†…å®¹
- **æ—¥å¿—è®°å½•ï¼š** å®Œæ•´çš„è°ƒç”¨é“¾è¿½è¸ª

### å»ºè®®Javaåç«¯ä¼˜åŒ–ï¼š
- **æ•°æ®ç¼“å­˜ï¼š** åŒåŸå¸‚å¤©æ°”ç¼“å­˜5-10åˆ†é’Ÿ
- **APIé™æµï¼š** é¿å…ç¬¬ä¸‰æ–¹APIè°ƒç”¨é¢‘ç¹
- **é”™è¯¯å¤„ç†ï¼š** æ¸…æ™°çš„é”™è¯¯ç å’Œä¿¡æ¯

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. å•ç‹¬æµ‹è¯•Java API
```bash
curl -H "Authorization: Bearer your-secret" \
     "http://java-server:8080/api/weather/device/ESP32_001"
```

### 2. æµ‹è¯•Pythoné›†æˆ
```python
# è¿è¡Œå¤©æ°”é—®å€™æµ‹è¯•
python proactive_greeting_example.py
```

### 3. ç«¯åˆ°ç«¯æµ‹è¯•
```bash
curl -X POST http://localhost:8003/xiaozhi/greeting/send \
  -H "Content-Type: application/json" \
  -d '{
    "device_id": "ESP32_001",
    "initial_content": "ä»Šå¤©å¤©æ°”å¦‚ä½•",
    "category": "weather",
    "user_info": {"name": "æå”", "age": 65}
  }'
```

## ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•

### Pythonç«¯é…ç½®ï¼š
- [ ] `config.yaml` ä¸­ `manager-api.url` æŒ‡å‘JavaæœåŠ¡å™¨
- [ ] `config.yaml` ä¸­ `manager-api.secret` é…ç½®æ­£ç¡®
- [ ] MQTTåŠŸèƒ½å·²å¯ç”¨
- [ ] ä¸»åŠ¨é—®å€™åŠŸèƒ½å·²å¯ç”¨

### Javaç«¯é…ç½®ï¼š
- [ ] å¤©æ°”APIæ¥å£å·²å®ç°
- [ ] è®¾å¤‡åŸå¸‚ç»‘å®šå…³ç³»å·²å»ºç«‹
- [ ] ç¬¬ä¸‰æ–¹å¤©æ°”APIå·²é…ç½®
- [ ] APIè®¤è¯æœºåˆ¶å·²å®ç°

## ğŸ”® åç»­è®¡åˆ’

### çŸ­æœŸæ”¹è¿›ï¼š
- [ ] æ”¯æŒæ›´å¤šå¤©æ°”æ•°æ®å­—æ®µ
- [ ] æ·»åŠ å¤©æ°”å‘Šè­¦åŠŸèƒ½
- [ ] ä¼˜åŒ–å¤©æ°”æè¿°è¯­è¨€

### é•¿æœŸè§„åˆ’ï¼š
- [ ] æ”¯æŒå¤šåŸå¸‚å¤©æ°”
- [ ] å¤©æ°”å†å²æ•°æ®åˆ†æ
- [ ] ä¸ªæ€§åŒ–å¤©æ°”å»ºè®®

## ğŸ“ æ”¯æŒä¿¡æ¯

### é‡åˆ°é—®é¢˜æ—¶ï¼š
1. **æŸ¥çœ‹æ—¥å¿—ï¼š** `tail -f tmp/server.log | grep -i weather`
2. **æµ‹è¯•Java APIï¼š** ä½¿ç”¨curlç›´æ¥æµ‹è¯•
3. **æ£€æŸ¥ç½‘ç»œï¼š** ç¡®è®¤Pythonåˆ°JavaæœåŠ¡å™¨çš„è¿é€šæ€§
4. **éªŒè¯é…ç½®ï¼š** ç¡®è®¤APIåœ°å€å’Œå¯†é’¥æ­£ç¡®

### è”ç³»æ–¹å¼ï¼š
- Pythonç«¯é—®é¢˜ï¼šæŸ¥çœ‹æœ¬é¡¹ç›®æ–‡æ¡£
- Javaç«¯é—®é¢˜ï¼šè”ç³»Javaåç«¯å·¥ç¨‹å¸ˆ
- é›†æˆé—®é¢˜ï¼šå‚è€ƒ `docs/java_weather_integration.md`

---

**æ€»ç»“ï¼š** å·²å®Œå…¨æŒ‰ç…§Javaå·¥ç¨‹å¸ˆå»ºè®®å®ç°å¤©æ°”APIé›†æˆï¼ŒPythonç«¯æ— éœ€è¿›ä¸€æ­¥ä¿®æ”¹ï¼Œç­‰å¾…Javaåç«¯æä¾›å¤©æ°”APIæ¥å£å³å¯æ­£å¸¸ä½¿ç”¨ã€‚
